<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Geoportal - Park šuma Marjan</title>
		<!--<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.3.1/ol.css">-->
		<link rel="stylesheet" href="ol_v10.3.1/ol.css">
		<style>
			body, html { margin: 0; padding: 0; font-family: Garamond, "Times New Roman", serif; color:#666666}
			#map { position: relative; width: 100%; height: 100vh; }
			
			#layersPanel {
				position: absolute;
				top: 50px;
				right: 10px;
				background: white;
				padding: 10px;
				border-radius: 5px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
				display: none;
			}

			#gotoCoordinatesPanel {
				position: absolute;
				top: 50px;
				right: 10px;
				background: white;
				padding: 10px;
				border-radius: 5px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
				display: none;
			}
			
			#downloadDataPanel {
				position: absolute;
				top: 50px;
				right: 10px;
				background: white;
				padding: 10px;
				border-radius: 5px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
				display: none;
			}

			#swipe1 {
				position: absolute;
				bottom: 35px; /* Keeps it at the bottom */
				left: 0;
				right: 0; /* Ensures full width without overflow */
				width: auto; /* Prevents forcing an exact width */
				
				padding: 5px 0;
				border-radius: 0;
				z-index: 1000;
				overflow: hidden; /* Prevents scrollbars */
			}
			
			#swipe{
				position: fixed;
				bottom: 55px; /* Keeps it at the bottom */
				left: 0;
				right: 0; /* Ensures full width without overflow */
				width: auto;
				/*overflow: hidden;  Prevents scrollbars */
				z-index: 5000;
				max-width:5000px;
			}
			
			#basemapMenu p, #overbasemapMenu p {
				margin-bottom: 0; /* Remove whitespace below the <p> */
			}

			#basemapMenu {
				/* Add space between the two menus */
				/* margin-bottom: 15px; */
			}		

			#bottomPanel1 {
				position: fixed;
				bottom: 2px;
				left: 50%;
				transform: translateX(-50%);
				background: rgba(255, 255, 255, 0.75);
				foreground: #666666;
				/*padding: 10px 20px;*/
				border-radius: 5px;
				text-align: center;
				
				display: flex; /* Use flexbox */
				align-items: center; /* Vertically center items */
				justify-content: center; /* Horizontally center items (optional) */
				z-index: 5000;
			}

			#bottomPanel {
				position: fixed;
				bottom: 20px;
				left: 50%;
				transform: translate(-50%, 0%);
				/*right:0;*/
				width:auto;
				background: transparent;
				foreground: #666666;
				/*padding: 10px 20px;*/
				border-radius: 5px;
				text-align: center;
				
				display: flex; /* Use flexbox */
				align-items: center; /* Vertically center items */
				justify-content: center; /* Horizontally center items (optional) */
				z-index: 5000;
			}
			
			#bottomPanel img { /* Target the image directly */
				margin: 5px; /* Add 5px margin on all sides */
			}

			#bottomPanel a { /* Target the link */
				margin: 0 5px; /* Add horizontal margin to the link */
			}

			#bottomPanelContainer{
				background:rgba(255, 255, 255, 0.75); 
				width:auto; 
				border-radius: 5px; 
				text-align: center; 
				display: flex; /* Use flexbox */
				align-items: center; /* Vertically center items */
				justify-content: center;
			}
			
			#map-link {
				color: #fff;
				text-decoration: none;
				font-size: 10px;
			}

			#map-link:hover {
				text-decoration: underline;
			}
			a{
				color: #666666;
			}
			a:active {
				color: #666666;
			}
			a:visited {
				color:#666666;
			}
			
			label{
				color: #666666;
			}
			.ol-control button {
				height:1.6em;
				width:1.6em
			}
			
			:fullscreen::backdrop { /* Or :not(:root):fullscreen::backdrop for more specificity */
				z-index: 1000; /* Adjust as needed - lower than your controls */
			}

			/* Ensure your controls have a higher z-index */
			.ol-control, #bottomPanel, #swipe, #layersPanel, #measureToolsPanel, #gotoCoordinatesPanel, #downloadDataPanel{
				z-index: 2000; /* Or higher */				
			}
			
			.ol-zoom {top: 3.5em;}
			
			.ol-control button {
				color:#62ba46;
				width:2em;
				height:2em
			}
			ol-control button:hoover {color:#62ba46}
			
			
			input[type='radio'] {
				accent-color: #62ba46;
			}	
			
			input[type='range'] {
				accent-color: #62ba46;
			}
			
			
			input[type='checkbox'] {
				accent-color: #62ba46;
			}
			p{margin:0px; padding:0px;}
			
			.toc-layer{
				margin-left:1em;
			}
			

			.ol-control button {
			    font-size: 1em;
			}
			.ol-touch .ol-control button {
			    font-size: 1em;
			}

			.ol-attribution{
				position:fixed;
			}

			.ol-scale-line {
				position: fixed;
			    bottom: 0px;
			    left: 0px;			       
			}

			.invalid {
	    		border: 2px solid red;
			}

			/*.ol-control{
				border: 2px solid #62ba46;
			}*/
			
			
			
			/* Remove default appearance */
			input[type="checkbox"] {
				-webkit-appearance: none; /* For Safari */
				-moz-appearance: none; /* For Firefox */
				appearance: none;
				width: 15px;
				height: 15px;
				border: 1px solid #666666; /* Default border */
				border-radius: 4px; /* Optional: Rounded corners */
				background-color: white;
				cursor: pointer;
				transition: background-color 0.3s ease, border-color 0.3s ease;
			}

			/* Change background when checked */
				input[type="checkbox"]:checked {
				background-color: #62ba46; /* Change to desired color */
				//border-color: #4CAF50;
			}
			
			
			input[type="radio"] {
				appearance: none; /* Removes default styling */
				width: 16px;
				height: 16px;
				border: 1px solid #666666; /* Border color */
				border-radius: 50%; /* Makes it round */
				outline: none;
				cursor: pointer;
				margin:auto;
				margin-left:10px;
			}

			input[type="radio"]:checked {
				background-color: #62ba46; /* Change to your desired color */
				border: 1px solid #666;
			}
			
			label {
				display: inline-flex;
				align-items: center; /* Vertically centers input and text */
				gap: 5px; /* Adds spacing between input and text */				
				margin-top:2px;
			}
			
			
			#changeLanguageButton:hover,
			#changeLanguageButton:active,
			#changeLanguageButton:focus {    
				color: #62ba46;
				box-shadow: none !important; /* Remove any shadow effects */
			}
		
			
			
			.close-panel-header{
				display: flex;
				justify-content: space-between;
				align-items: center;
				background: #62ba46;
				padding: 3px 3px 3px 10px;
				border-radius: 3px 3px 0 0;
				color: white;
				margin-bottom: 10px;
			}
			
			
			.close-panel-button{
				background: none; 
				border: none; 
				color: white; 
				font-size: 16px; 
				cursor: pointer;
			}
			
			.report-problem-top{
				top:0.5em; 
				left: 3.5em;
			}
			
			.change-language-top{
				position:absolute; 
				top:0.5em; 
				left:5.6em;
			}
			
			.report-problem-left{
				left:0.5em; 
				top: 15.1em;
			}
			
			.change-language-left{
				position:absolute; 
				left:0.5em; 
				top:10.5em;
			}
			
			.help-left{
				position:absolute; 
				left:0.5em; 
				top:12.6em;
			}
			
			
			.report-issue-panel {
				display: none; /* Initially hidden */
				position: absolute; /* Cover the entire viewport */
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				width: 80%;
				height: 80%;
				z-index: 3000; /* Ensure it's on top of everything */
				overflow: hidden; /* Prevent scrollbars on the iframe */
				align-items: center;
				justify-content: center;
				
				background: white;
				padding: 8px;
				border: 1px solid rgb(98, 186, 70);
				border-radius: 5px;
			}
			.report-issue-content {
				background: white;
				padding: 10px;
				border-radius: 8px;
				width: 50%;
				display: flex;
				flex-direction: column;
				gap: 5px; /* Adds spacing between elements */
				width: auto;
				max-height: 75vh; /* Limits height to 60% of the viewport */
				overflow: auto; /* Adds scrollbar only when needed */
			}
			
			.report-issue-content {
				display: flex;
				flex-direction: column;
				margin-bottom: 0px;
				height: 90%;
			}

			.report-issue-content label {
				margin-top: 5px;
			}

			.report-issue-content input:not([type="radio"]),
			.report-issue-content textarea {
				padding: 8px;
				border: 1px solid #ccc;
				border-radius: 4px;
				font-size: 14px;
				color:#666666;
			}
			.report-issue-content textarea {
				resize: vertical; /* Allows resizing only vertically */
				min-height: 40px;
				height: 120px;
			}

			#submitReportButton {
				background: #62ba46;
				color: white;
				border: none;
				padding: 10px;
				cursor: pointer;
				border-radius: 5px;
				font-size: 16px;
				transition: background 0.3s ease;
			}

			#submitReportButton:hover {
				background: #519d3c;
			}
			
			
			
			#reportProblemPanel {
				display: none; /* Initially hidden */
				position: absolute; /* Cover the entire viewport */
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				width: 80%;
				height: 80%;
				background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent backdrop */
				z-index: 3000; /* Ensure it's on top of everything */
				overflow: hidden; /* Prevent scrollbars on the iframe */
				
			}

			#reportProblemIframe {
				border: none; /* Remove iframe border */
				position:relative;
				width:100%;
				height:100%
			}
			
		</style>
	</head>
	<body>
		<a style="display:none" id="printscreenDownload" download="Marjan_Geoportal.png"></a>
		<!--Stari panel za prijavu problema s iframeom
		<div id="reportProblemPanel">
			<iframe id="reportProblemIframe" src=""></iframe> 
		</div>-->
		
		<div id="reportIssuePanel" class="report-issue-panel">
			<div class="close-panel-header">
				<span id="reportIssuePanelHeaderSpan">Prijava građana</span>
				<button id="reportIssuePanelCloseButton" class="close-panel-button">&#x2716;</button>
			</div>
			<div class="report-issue-content">
				<label id="reportIssuePanelNameLabel" for="reportName">Ime:</label>
				<input type="text" id="reportName" name="reportName" required>
					
				<label id="reportIssuePanelSurnameLabel" for="reportSurname">Prezime:</label>
				<input type="text" id="reportIssuePanelSurnameInput" name="reportSurname" required>
					
				<label id="reportIssuePanelEmailLabel" for="reportEmail">*E-mail:</label>
				<input type="email" id="reportIssuePanelEmailInput" name="reportEmail" required>
					
				<label id="reportIssuePanelSubjectLabel" for="reportSubject">Predmet:</label>
				<input type="text" id="reportIssuePanelSubjectInput" name="reportSubject" required>
				
				
				<label id="reportIssuePanelLocationLabel" for="reportLocation">Lokacija:</label>
				<div style="display: flex; align-items: center; gap: 20px; margin-top: 5px; justify-content:center">
					<div style="display: flex; align-items: center; gap: 5px;">
						<input type="radio" id="reportIssuePanelMyLocationRadio" name="reportIssuePanelLocationChoice" value="currentLocation" onchange="handleReportProblemLocationRadioChange()" checked>
						<label id="reportIssuePanelMyLocationLabel" style="margin-bottom: 0px;" for="reportIssuePanelMyLocationRadio" >Trenutna lokacija</label>
					</div>

					<div style="display: flex; align-items: center; gap: 5px;">
						<input type="radio" id="reportIssuePanelMapLocationRadio" name="reportIssuePanelLocationChoice" value="mapSelection" onchange="handleReportProblemLocationRadioChange()">
						<label id="reportIssuePanelMapLocationLabel" style="margin-bottom: 0px;" for="reportIssuePanelMapLocationRadio">Odaberi na karti</label>
					</div>

					<div style="display: flex; align-items: center; gap: 5px;">
						<input type="radio" id="reportIssuePanelNoLocationRadio" name="reportIssuePanelLocationChoice" value="noLocation" onchange="handleReportProblemLocationRadioChange()">
						<label id="reportIssuePanelNoLocationLabel" style="margin-bottom: 0px;" for="reportIssuePanelNoLocationRadio">Bez lokacije</label>
					</div>
				</div>
				
				
				<input type="text" id="reportIssuePanelLocationInput" name="reportLocation" required>
					
				<label id="reportIssuePanelMessageLabel" for="reportMessage">*Poruka:</label>
				<textarea id="reportIssuePanelMessageInput" name="reportMessage" rows="5" required></textarea>
				
				<div style="display: flex; gap: 5px; align-items: center; margin-top:10px"> 
					<button id="reportIssuePanelSendMessageButton" title="Pošalji prijavu" style="width: 100%; padding: 5px; font-family: Garamond, Times New Roman, serif; display: flex; align-items: center; justify-content: center; background: white; border-radius: 2px; border-width: 1px; border-color: rgba(128, 128, 128, 0.25); color:#666666; gap:5px">  						
					<img id="reportIssuePanelSendMessageButtonImg" src="icons/file-signature-solid.svg" alt="Pošalji prijavu" width="20" height="20">
  						<span id="reportIssuePanelSendMessageButtonSpan">Pošalji prijavu</span>  
					</button>
    			</div>
				
				<!--<button id="submitReportButton">Pošalji</button>-->
			</div>
		</div>
		
		
		<div id="map">			
			<input id="swipe" type="range" min="0" max="100" value="95">
			<!--<div id="basemap-selector">
				<label for="basemaps">Choose a basemap:</label>
				<select id="basemaps">
					<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2011/wms">Ortofoto 2011</option>
					<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2014-2016/wms">Ortofoto 2014-2016</option>
					<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2017_2018/wms">Ortofoto 2017-2018</option>
					<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2019_2020/wms">Ortofoto 2019-2020</option>
					<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2021_2022/wms">Ortofoto 2021-2022</option>
				</select>
			</div>-->
			<div class="ol-control report-problem-left">  
				<button id="reportProblemButton" title="Prijava građana" class="ol-controlButton">  
					<img id="reportProblemImg" src="icons/file-signature-solid.svg" alt="Prijava građana" width="20" height="20" />
				</button>
			</div>
				
			
			<div title="Promijeni jezik" class="ol-unselectable ol-control change-language-left">
				<button id="changeLanguageButton">
					EN
				</button>
			</div>
			
			<div title="Korisnički priručnik" class="ol-unselectable ol-control help-left">
				<button id="helpButton">
					<a id="helpButtonLink" style="color: #62ba46;" href="Marjan_Geoportal_korisnicki_prirucnik.pdf" target="_blank">?</a>
				</button>
			</div>
			
			<div class="ol-control" style="top:8em; left: 0.5em;">  
				<button id="locationTrackingButton" title="Moja lokacija" class="ol-controlButton">  
					<img id="locationTrackingImg" src="icons/location-crosshairs-solid.svg" alt="Moja lokacija" width="20" height="20" />
				</button>
			</div>

			<div style=" position:absolute; top:0.5em; right:42px" class="ol-full-screen ol-unselectable ol-control" style="pointer-events: auto;">
				<button id="fullExtentButton" title="Početni prikaz" >
					<img id="fullExtentButtonImg" src="icons/arrows-to-circle-solid.svg" alt="Početni prikaz" width="20" height="20" />
				</button>
			</div>
			
			<div style=" position:absolute; top:0.5em; right:76px" title="Slojevi"  class="ol-unselectable ol-control" style="pointer-events: auto;">
				<button id="layerMenuButton">
					<img id="layerMenuButtonImg" src="icons/layer-group-solid.svg" alt="Slojevi" width="20" height="20" />
				</button>
			</div>
			
			<div style="position:absolute; top:0.5em; right:110px" title="Crtanje i mjerenje"  class="ol-full-screen ol-unselectable ol-control">
				<button id="measureToolsButton">
					<img id="measureToolsButtonImg" src="icons/pencil-solid.svg" alt="Crtanje i mjerenje" width="20" height="20" />
				</button>
			</div>
			
			<div style="position:absolute; top:0.5em; right:144px" title="Idi na koordinate"  class="ol-full-screen ol-unselectable ol-control">
				<button id="gotoCoordinatesPanelButton">
					<img id="gotoCoordinatesPanelButtonImg" src="icons/map-location-dot-solid.svg" alt="Idi na koordinate" width="20" height="20" />
				</button>
			</div>

			<div style="position:absolute; top:0.5em; right:178px" title="Spremi kartu"  class="ol-full-screen ol-unselectable ol-control">
				<button id="printMapButton">
					<img id="printMapButtonImg" src="icons/print-solid.svg" alt="Spremi kartu" width="20" height="20" />
				</button>
			</div>
			<div style="position:absolute; top:0.5em; right:212px" title="Dodaj KML" class="ol-full-screen ol-unselectable ol-control">
				<button id="uploadKMLButton">
					<img id="uploadKMLButtonImg" src="icons/file-circle-plus-solid.svg" alt="Dodaj KML" width="20" height="20" />
				</button>
			</div>
			<div style="position:absolute; top:0.5em; right:246px" title="Preuzmi podatke" class="ol-full-screen ol-unselectable ol-control">
				<button id="downloadDataButton">
					<img id="downloadDataButtonImg" src="icons/object-group-regular.svg" alt="Preuzimanje podataka" width="20" height="20" />
				</button>
			</div>
			
			
			

			<!-- Meni sa dugmadima za slojeve -->
			<!-- <div id="layer-menu2">
				<button data-url="https://geoportal.dgu.hr/services/inspire/orthophoto_2011/wms">Ortofoto 2011</button>
				<button data-url="https://geoportal.dgu.hr/services/inspire/orthophoto_2014-2016/wms">Ortofoto 2014-2016</button>
				<button data-url="https://geoportal.dgu.hr/services/inspire/orthophoto_2017_2018/wms">Ortofoto 2017-2018</button>
				<button data-url="https://geoportal.dgu.hr/services/inspire/orthophoto_2019_2020/wms">Ortofoto 2019-2020</button>
				<button data-url="https://geoportal.dgu.hr/services/inspire/orthophoto_2021_2022/wms">Ortofoto 2021-2022</button>
			</div> -->

			
			<div id="gotoCoordinatesPanel" style="display: none; position: absolute; top: 50px; right: 10px; background: white; padding: 8px; border: 1px solid #62ba46; border-radius: 5px; max-width:250px">
				<div  class="close-panel-header">
					<span id="gotoCoordinatesPanelHeaderSpan">Idi na koordinate</span>
					<button id="gotoCoordinatesPanelCloseButton" class="close-panel-button">✖</button>
				</div>
				
    			<div style="display: flex; gap: 5px; align-items: center; padding-bottom: 5px">  
					<label for="XCoordinate" style="margin-right: 5px;">X / λ:</label> <input style="color:#666666; border-color:rgba(128, 128, 128, 0.25)" type="text" id="XCoordinate" name="XCoordinate">
    			</div>
    			<div style="display: flex; gap: 5px; align-items: center; padding-bottom: 5px"> 
					<label for="YCoordinate" style="margin-right: 5px;">Y / φ:</label> <input style="color:#666666; border-color:rgba(128, 128, 128, 0.25)" type="text" id="YCoordinate" name="YCoordinate">
    			</div>
				<div id="gotoCoordinatesWarning" style="display: none; text-align: justify; padding: 5px 0; color:#666666;">Podržani sustavi su WGS84, formati: 
					</br>16.410</br>16 24.6</br>16 24 36.1</br>i HTRS96TM.
					</br>
						Ukoliko se upisuju formati DD MM.mmm i DD MM SS.sss koristite razmak između stupnjeva, minuta i sekunda.
					</br>Pazite na upisane vrijednosti.
    			</div>
				<div style="display: flex; gap: 5px; align-items: center;"> 
					<button id="gotoCoordinatesButton" title="Prikaži lokaciju" style="width: 100%; padding: 5px; font-family: Garamond, Times New Roman, serif; display: flex; align-items: center; justify-content: center; background: white; border-radius: 2px; border-width: 1px; border-color: rgba(128, 128, 128, 0.25); color:#666666; gap:5px">  						
					<img id="gotoCoordinatesButtonImg" src="icons/map-location-dot-solid.svg" alt="Prikaži lokaciju" width="20" height="20">
  						<span id="gotoCoordinatesButtonSpan">Prikaži lokaciju</span>  
					</button>
    			</div>
    		</div>
			
			
			<div id="downloadDataPanel" style="display: none; position: absolute; top: 50px; right: 10px; background: white; padding: 8px; border: 1px solid #62ba46; border-radius: 5px; max-width:250px">
			
				<div  class="close-panel-header">
					<span id="downloadDataPanelHeaderSpan">Preuzimanje podataka</span>
					<button id="downloadDataPanelCloseButton" class="close-panel-button">✖</button>
				</div>
				<div id="downloadImageDataMenu" style="padding-bottom: 5px">
					<p id="downloadImageDataMenuP" style="color: #666666; margin-bottom: 5px;">Sloj za preuzimanje:</p>					
						<label id="downloadImageDataMenu2024Hillshade2mLabel"><input id="downloadImageDataMenu2024Hillshade2m" type="radio" name="downloadWCS" class="toc-layer" data-layer="Marjan_hillshade_2024_50cm">
							<span id="downloadImageDataMenu2024Hillshade2mSpan">Sjenčani DSM 2024. (50cm)</span>
						</label><br>
						<label id="downloadImageDataMenu2024DSM2mLabel"><input id="downloadImageDataMenu2024DSM2m" type="radio" name="downloadWCS" class="toc-layer" data-layer="Marjan_DSM_2024_50cm">
							<span id="downloadImageDataMenu2024DSM2mSpan">DSM 2024. (50cm)</span>
						</label><br>
						<label id="downloadImageDataMenu2024Ortofoto1cmLabel"><input id="downloadImageDataMenu2024Ortofoto1cm" type="radio" name="downloadWCS" class="toc-layer" data-layer="Marjan_orto_2024_5cm" checked>
							<span id="downloadImageDataMenu2024Ortofoto1cmSpan">Ortofoto 2024. (5cm)</span>
						</label><br><br>
						<label id="downloadImageDataMenu20251Hillshade2mLabel"><input id="downloadImageDataMenu20251Hillshade2m" type="radio" name="downloadWCS" class="toc-layer" data-layer="Marjan_hillshade_2025_1_50cm">
							<span id="downloadImageDataMenu20251Hillshade2mSpan">Sjenčani DSM 2025. (50cm)</span>
						</label><br>
						<label id="downloadImageDataMenu20251DSM2mLabel"><input id="downloadImageDataMenu20251DSM2m" type="radio" name="downloadWCS" class="toc-layer" data-layer="Marjan_DSM_2025_1_50cm">
							<span id="downloadImageDataMenu20251DSM2mSpan">DSM 2025. (50cm)</span>
						</label><br>
						<label id="downloadImageDataMenu20251Ortofoto1cmLabel"><input id="downloadImageDataMenu20251Ortofoto1cm" type="radio" name="downloadWCS" class="toc-layer" data-layer="Marjan_orto_2025_1_5cm" checked>
							<span id="downloadImageDataMenu20251Ortofoto1cmSpan">Ortofoto 2025. (5cm)</span>
						</label><br>
						<!--<label><input type="radio" name="basemap" class="toc-layer" data-layer="HOK" data-layer-service="WMTS">HOK</label><br>-->
				</div>
				<div id="downloadImageDataWarning" style="margin:8px; align-items: center; display: none">
				Molimo sačekajte.<br>Podaci za preuzimanje se pripremaju.<br>Priprema i preuzimanje mogu potrajati i nekoliko minuta, nakon čega će podaci biti preuzeti na vaš uređaj.
    			</div>
				<div style="display: flex; gap: 5px; align-items: center;"> 
					<button id="downloadImageDataButton" title="Preuzmi podatke" style="width: 100%; padding: 5px; font-family: Garamond, Times New Roman, serif; display: flex; align-items: center; justify-content: center; background: white; border-radius: 2px; border-width: 1px; border-color: rgba(128, 128, 128, 0.25); color:#666666; gap:5px">  						
						<img id="downloadImageDataButtonImg" src="icons/object-group-regular.svg" alt="Preuzmi podatke" width="20" height="20">
  						<span id="downloadImageDataButtonSpan">Preuzmi podatke</span>  
					</button>
    			</div>
    		</div>
			
			
			<div id="layersPanel" style="display: none; background:white; padding:8px; border:1px solid #62ba46; border-radius:5px;">
				<div  class="close-panel-header">
					<span id="layersPanelHeaderSpan">Slojevi</span>
					<button id="layersPanelCloseButton" class="close-panel-button">✖</button>
				</div>
				
				<div id="basemapMenu">
					<p id="basemapMenuP" style="color: #666666; margin-bottom: 5px; font-weight:bold;">Pozadinski sloj:</p>
					<!--<div>Pozadinski sloj:
						<select id="overbasemapMenuSelect" style="color:#666666">
							<option value="OSM" data-layer-service="WMTS">OpenStreetMap</option>
							<option value="TK25" data-layer-service="WMTS">TK25</option>
							<option value="DMR_BW" data-layer-service="WMS">Reljef</option>
							<option value="HOK" data-layer-service="WMS">HOK</option>
							<option value="DOF_2011" data-layer-service="WMTS">Ortofoto 2011</option>
							<option value="DOF_2014_2016" data-layer-service="WMTS">Ortofoto 2014-2016</option>
							<option value="DOF_2017_2018" data-layer-service="WMTS">Ortofoto 2017-2018</option>
							<option value="DOF_2019_2020" data-layer-service="WMTS">Ortofoto 2019-2020</option>
							<option value="DOF_2021_2022" data-layer-service="WMTS">Ortofoto 2021-2022</option>
							<option value="DOF_Lidar_2023" data-layer-service="WMTS">LiDAR Ortofoto 2023</option>
							<option value="Marjan_hillshade_2024_2m" data-layer-service="WMTS">Marjan DSM 2024</option>
							<option value="Marjan_hillshade_2025_2m" data-layer-service="WMTS">Marjan DSM 2025</option>
						</select>
					</div>-->
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px 15px; margin-left: 10px">
						<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
							<input id="basemapMenuOSM" type="radio" name="basemap" class="toc-layer" data-layer="OSM" data-layer-service="WMTS" style="margin: 0;">
						<span id="basemapMenuOSMSpan" style="vertical-align: middle;">OpenStreetMap</span>
						</label>
						<p id="basemapMenuSourceP1" style="grid-column: 1 / -1; color: #666666; margin-top: 2px; text-align: center;">
							Izvor: DGU
						</p>
						<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
							<input id="basemapMenuTK25" type="radio" name="basemap" class="toc-layer" data-layer="TK25" data-layer-service="WMTS" style="margin: 0;">
							<span id="basemapMenuTK25Span">TK25</span>
						</label>
						<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
							<input id="basemapMenuDMRBW" type="radio" name="basemap" class="toc-layer" data-layer="DMR_BW" data-layer-service="WMS" style="margin: 0;">
							<span id="basemapMenuDMRBWSpan">Sjenčani reljef</span>
						</label>
						<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
							<input id="basemapMenuHOK" type="radio" name="basemap" class="toc-layer" data-layer="HOK" data-layer-service="WMTS" style="margin: 0;">
							<span id="basemapMenuHOKSpan">HOK</span>
						</label>
						<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
							<input id="basemapMenuOrtofotoDOF2011" type="radio" name="basemap" class="toc-layer" data-layer="DOF_2011" data-layer-service="WMTS" style="margin: 0;">
							<span id="basemapMenuDOF2011Span">Ortofoto 2011</span>
						</label>
						<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
							<input id="basemapMenuDOF20142016" type="radio" name="basemap" class="toc-layer" data-layer="DOF_2014_2016" data-layer-service="WMTS" style="margin: 0;">
							<span id="basemapMenuDOF20142016Span">Ortofoto 2014-2016</span>
						</label>
						<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
							<input id="basemapMenuDOF20172018" type="radio" name="basemap" class="toc-layer" data-layer="DOF_2017_2018" data-layer-service="WMTS" style="margin: 0;">
							<span id="basemapMenuDOF20172018Span">Ortofoto 2017-2018</span>
						</label>
						<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
							<input id="basemapMenuDOF20192020" type="radio" name="basemap" class="toc-layer" data-layer="DOF_2019_2020" data-layer-service="WMTS" style="margin: 0;">
							<span id="basemapMenuDOF20192020Span">Ortofoto 2019-2020</span>
						</label>
						<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
							<input id="basemapMenuDOF20212022" type="radio" name="basemap" class="toc-layer" data-layer="DOF_2021_2022" data-layer-service="WMTS" style="margin: 0;">
							<span id="basemapMenuDOF20212022Span">Ortofoto 2021-2022</span>
						</label>
						<p id="basemapMenuSourceP2" style="grid-column: 1 / -1; color: #666666; margin-top: 2px; text-align: center;">
							Izvor: Park šuma Marjan
						</p>
						<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
							<input id="basemapMenuMarjanHillshade20242m" type="radio" name="basemap" class="toc-layer" data-layer="Marjan_hillshade_2024_50cm" data-layer-service="WMTS" style="margin: 0;">
							<span id="basemapMenuMarjanHillshade20242mSpan">Sjenčani DSM 2024.(50cm)</span>
						</label>
						<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
							<input id="basemapMenuMarjanHillshade20252m" type="radio" name="basemap" class="toc-layer" data-layer="Marjan_hillshade_2025_1_50cm" data-layer-service="WMTS" style="margin: 0;">
							<span id="basemapMenuMarjanHillshade20252mSpan">Sjenčani DSM 2025.(50cm)</span>
						</label>
					</div>
				</div>
				
				<!--<div id="basemapMenu">
					<p id="basemapMenuP" style="color: #666666; margin-bottom: 5px;">Pozadinski sloj:</p>
					<label><input id="basemapMenuOSM" type="radio" name="basemap" class="toc-layer" data-layer="OSM" data-layer-service="WMTS"><span id="basemapMenuOSMSpan">OSM</span></label><br>
					<label><input id="basemapMenuTK25" type="radio" name="basemap" class="toc-layer" data-layer="TK25" data-layer-service="WMTS"><span id="basemapMenuTK25Span">TK25</span></label><br>
					<label><input id="basemapMenuDMRBW" type="radio" name="basemap" class="toc-layer" data-layer="DMR_BW" data-layer-service="WMS"><span id="basemapMenuDMRBWSpan">Reljef</span></label><br>
					<label><input id="basemapMenuHOK" type="radio" name="basemap" class="toc-layer" data-layer="HOK" data-layer-service="WMTS"><span id="basemapMenuHOKSpan">HOK</span></label><br>
					<label><input id="basemapMenuOrtofotoDOF2011" type="radio" name="basemap" class="toc-layer" data-layer="DOF_2011" data-layer-service="WMTS"><span id="basemapMenuDOF2011Span">Ortofoto 2011</span></label><br>
					<label><input id="basemapMenuDOF20142016" type="radio" name="basemap" class="toc-layer" data-layer="DOF_2014_2016" data-layer-service="WMTS"><span id="basemapMenuDOF20142016Span">Ortofoto 2014-2016</span></label><br>
					<label><input id="basemapMenuDOF20172018" type="radio" name="basemap" class="toc-layer" data-layer="DOF_2017_2018" data-layer-service="WMTS"><span id="basemapMenuDOF20172018Span">Ortofoto 2017-2018</span></label><br>
					<label><input id="basemapMenuDOF20192020" type="radio" name="basemap" class="toc-layer" data-layer="DOF_2019_2020" data-layer-service="WMTS"><span id="basemapMenuDOF20192020Span">Ortofoto 2019-2020</span></label><br>
					<label><input id="basemapMenuDOF20212022" type="radio" name="basemap" class="toc-layer" data-layer="DOF_2021_2022" data-layer-service="WMTS"><span id="basemapMenuDOF20212022Span">Ortofoto 2021-2022</span></label><br>
					<label><input id="basemapMenuMarjanHillshade20242m" type="radio" name="basemap" class="toc-layer" data-layer="Marjan_hillshade_2024_2m" data-layer-service="WMTS"><span id="basemapMenuMarjanHillshade20242mSpan">Marjan DSM 2024</span></label><br>
					<label><input id="basemapMenuMarjanHillshade20252m" type="radio" name="basemap" class="toc-layer" data-layer="Marjan_hillshade_2025_2m" data-layer-service="WMTS"><span id="basemapMenuMarjanHillshade20252mSpan">Marjan DSM 2025</span></label><br>
				</div>-->
				<hr style="border:1px solid #ccc; margin:5px 0px 10px 0px;">
				<div id="overbasemapMenu">				
					<div id="overbasemapMenuP" style="display: flex; margin-bottom: 5px; align-items: center; gap:5px">
						<label>
							<span id="overbasemapMenuPSpan" style="font-weight:bold;">Dodatni sloj:</span>
							<!--<select id="overbasemapMenuSelect" style="color:#666666">
								<option value="DOF_2011" data-layer-service="WMTS">Ortofoto 2011</option>
								<option value="DOF_2014_2016" data-layer-service="WMTS">Ortofoto 2014-2016</option>
								<option value="DOF_2017_2018" data-layer-service="WMTS">Ortofoto 2017-2018</option>
								<option value="DOF_2019_2020" data-layer-service="WMTS">Ortofoto 2019-2020</option>
								<option value="DOF_2021_2022" data-layer-service="WMTS">Ortofoto 2021-2022</option>
								<option value="DOF_Lidar_2023" data-layer-service="WMTS">LiDAR Ortofoto 2023</option>
								<option value="Marjan_jug_orto_2024_5cm" data-layer-service="WMTS">Marjan Ortofoto 2024</option>
								<option value="Marjan_jug_orto_2025_5cm" data-layer-service="WMTS">Marjan Ortofoto 2025</option>
							</select>-->
						</label>
						<input type="range" id="overbasemapVisibilitySlider" style="margin-left: auto;" min="0" max="1" step="0.1" value="1">
					</div>
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px 15px; margin-left: 10px">
						<p id="overbasemapMenuSourceP1" style="grid-column: 1 / -1; color: #666666; margin-top: 2px; text-align: center;">
							Izvor: DGU
						</p>
						<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;"><input style="margin: 0;" id="overbasemapMenuDOF2011" type="radio" name="overbasemap" class="toc-layer" data-layer="DOF_2011" data-layer-service="WMTS"><span id="overbasemapMenuDOF2011Span" >Ortofoto 2011</span></label>
						<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;"><input style="margin: 0;" id="overbasemapMenuDOF20142016" type="radio" name="overbasemap" class="toc-layer" data-layer="DOF_2014_2016" data-layer-service="WMTS"><span id="overbasemapMenuDOF20142016Span">Ortofoto 2014-2016</span></label>
						<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;"><input style="margin: 0;" id="overbasemapMenuDOF20172018" type="radio" name="overbasemap" class="toc-layer" data-layer="DOF_2017_2018" data-layer-service="WMTS"><span id="overbasemapMenuDOF20172018Span">Ortofoto 2017-2018</span></label>
						<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;"><input style="margin: 0;" id="overbasemapMenuDOF20192020" type="radio" name="overbasemap" class="toc-layer" data-layer="DOF_2019_2020" data-layer-service="WMTS"><span id="overbasemapMenuDOF20192020Span">Ortofoto 2019-2020</span></label>
						<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;"><input style="margin: 0;" id="overbasemapMenuDOF20212022" type="radio" name="overbasemap" class="toc-layer" data-layer="DOF_2021_2022" data-layer-service="WMTS"><span id="overbasemapMenuDOF20212022Span">Ortofoto 2021-2022</span></label>
						<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;"><input style="margin: 0;" id="overbasemapMenuDOFLidar2023" type="radio" name="overbasemap" class="toc-layer" data-layer="DOF_Lidar_2023" data-layer-service="WMTS"><span id="overbasemapMenuDOFLidar2023Span">LiDAR Ortofoto 2023</span></label>
						<p id="overbasemapMenuSourceP2" style="grid-column: 1 / -1; color: #666666; margin-top: 2px; text-align: center;">
							Izvor: Park šuma Marjan
						</p>
						<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;"><input style="margin: 0;" id="overbasemapMenuMarjanjugOrto20245cm" type="radio" name="overbasemap" class="toc-layer" data-layer="Marjan_orto_2024_5cm" data-layer-service="WMTS">
							<span id="overbasemapMenuMarjanjugOrto20245cmSpan">Ortofoto 2024. (5cm)</span>
						</label>
						<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;"><input style="margin: 0;" id="overbasemapMenuMarjanjugOrto20255cm" type="radio" name="overbasemap" class="toc-layer" data-layer="Marjan_orto_2025_1_5cm" data-layer-service="WMTS">
							<span id="overbasemapMenuMarjanjugOrto20255cmSpan">Ortofoto 2025. (5cm)</span>
						</label>
					</div>
				</div>
				<hr style="border:1px solid #ccc; margin:5px 0px 10px 0px;">
				<!--
				<div id="overbasemapMenu">				
					<div id="overbasemapMenuP" style="display: flex; margin-bottom: 5px; align-items: center; gap:5px"><label><span id="overbasemapMenuPSpan">Dodatni sloj:</span></label><input type="range" id="overbasemapVisibilitySlider" style="margin-left: auto;" min="0" max="1" step="0.1" value="1"></div>
					<label><input id="overbasemapMenuDOF2011" type="radio" name="overbasemap" class="toc-layer" data-layer="DOF_2011" data-layer-service="WMTS"><span id="overbasemapMenuDOF2011Span" >Ortofoto 2011</span></label><br>
					<label><input id="overbasemapMenuDOF20142016" type="radio" name="overbasemap" class="toc-layer" data-layer="DOF_2014_2016" data-layer-service="WMTS"><span id="overbasemapMenuDOF20142016Span">Ortofoto 2014-2016</span></label><br>
					<label><input id="overbasemapMenuDOF20172018" type="radio" name="overbasemap" class="toc-layer" data-layer="DOF_2017_2018" data-layer-service="WMTS"><span id="overbasemapMenuDOF20172018Span">Ortofoto 2017-2018</span></label><br>
					<label><input id="overbasemapMenuDOF20192020" type="radio" name="overbasemap" class="toc-layer" data-layer="DOF_2019_2020" data-layer-service="WMTS"><span id="overbasemapMenuDOF20192020Span">Ortofoto 2019-2020</span></label><br>
					<label><input id="overbasemapMenuDOF20212022" type="radio" name="overbasemap" class="toc-layer" data-layer="DOF_2021_2022" data-layer-service="WMTS"><span id="overbasemapMenuDOF20212022Span">Ortofoto 2021-2022</span></label><br>
					<label><input id="overbasemapMenuDOFLidar2023" type="radio" name="overbasemap" class="toc-layer" data-layer="DOF_Lidar_2023" data-layer-service="WMTS"><span id="overbasemapMenuDOFLidar2023Span">LiDAR Ortofoto 2023</span></label><br>
					<label><input id="overbasemapMenuMarjanjugOrto20245cm" type="radio" name="overbasemap" class="toc-layer" data-layer="Marjan_jug_orto_2024_5cm" data-layer-service="WMTS"><span id="overbasemapMenuMarjanjugOrto20245cmSpan">Marjan Ortofoto 2024</span></label><br>
					<label><input id="overbasemapMenuMarjanjugOrto20255cm" type="radio" name="overbasemap" class="toc-layer" data-layer="Marjan_jug_orto_2025_5cm" data-layer-service="WMTS"><span id="overbasemapMenuMarjanjugOrto20255cmSpan">Marjan Ortofoto 2025</span></label><br>
				<br/>
				</div>-->
				
				<div id="katastarLayerControls" style="display: flex; align-items: center; gap:5px; padding:2px">  
					<label id="katastarLayerVisibilityLabel" for="katastarLayerVisibilityCheckbox" style="display: flex; align-items: center; gap: 5px">
						<input type="checkbox" id="katastarLayerVisibilityCheckbox"><span id="katastarLayerVisibilitySpan" style="font-weight:bold;">Katastarske čestice  </span></label>
					<input type="range" id="katastarLayerVisibilitySlider" style="margin-left: auto;" min="0" max="1" step="0.1" value="1">
				</div>
				<!--<div id="prometLayer-controls" style="display: flex; align-items: center; gap:5px">  
					<label for="prometLayerVisibility-checkbox" style="display: flex; align-items: center;"><input type="checkbox" id="prometLayerVisibility-checkbox" checked>Promet  </label>
					<input type="range" id="prometLayerVisibility-slider" style="margin-left: auto;" min="0" max="1" step="0.1" value="1">
				</div>	
				<div id="adreseLayer-controls" style="display: flex; align-items: center; gap:5px">  
					<label for="adreseLayerVisibility-checkbox" style="display: flex; align-items: center;"><input type="checkbox" id="adreseLayerVisibility-checkbox" checked>Adrese  </label>
					<input type="range" id="adreseLayerVisibility-slider" style="margin-left: auto;" min="0" max="1" step="0.1" value="1">
				</div>
				<div id="zgradeLayer-controls" style="display: flex; align-items: center; gap:5px">  
					<label for="zgradeLayerVisibility-checkbox" style="display: flex; align-items: center;"><input type="checkbox" id="zgradeLayerVisibility-checkbox" checked>Zgrade  </label>
					<input type="range" id="zgradeLayerVisibility-slider" style="margin-left: auto;" min="0" max="1" step="0.1" value="1">
				</div>-->
				<div id="measureLayerControls" style="display: flex; align-items: center; gap:5px; padding:2px">  
					<label id="measureLayerVisibilityLabel" for="measureLayerVisibilityCheckbox" style="display: flex; align-items: center; gap: 5px">
						<input type="checkbox" id="measureLayerVisibilityCheckbox" checked><span id="measureLayerVisibilitySpan" style="font-weight:bold;">Crtanje/Mjerenje  </span></label>
					<input type="range" id="measureLayerVisibilitySlider" style="margin-left: auto;" min="0" max="1" step="0.1" value="1">
					<div class="ol-control ol-unselectable" style="pointer-events: auto; position: relative;">
						<button id="zoomToExtentGrafikaButton" title="Zumiraj na sloj" style="padding: 2px; width: 1.5em; height: 1.5em; background: white; display: flex; align-items: center; justify-content: center;">
							<img id="zoomToExtentGrafikaImg" src="icons/arrows-to-circle-solid.svg" alt="Zumiraj na sloj" width="15px" height="15px">
						</button>
					</div>
				</div>
				<div id="goToCoordsLayerControls" style="display: flex; align-items: center; gap:5px; padding:2px">  
					<label id="goToCoordsLayerVisibilityLabel" for="goToCoordsLayerVisibilityCheckbox" style="display: flex; align-items: center; gap: 5px">
						<input type="checkbox" id="goToCoordsLayerVisibilityCheckbox" checked><span id="goToCoordsLayerVisibilitySpan" style="font-weight:bold;">Idi na koordinate  </span></label>
					<input type="range" id="goToCoordsLayerVisibilitySlider" style="margin-left: auto;" min="0" max="1" step="0.1" value="1">
					<div class="ol-control ol-unselectable" style="pointer-events: auto; position: relative;">
						<button id="zoomToExtentIdiNaKoordinateButton" title="Zumiraj na sloj" style="padding: 2px; width: 1.5em; height: 1.5em; background: white; display: flex; align-items: center; justify-content: center;">
							<img id="zoomToExtentIdiNaKoordinateImg" src="icons/arrows-to-circle-solid.svg" alt="Zumiraj na sloj" width="15px" height="15px">
						</button>
					</div>
				</div>
			</div>
			

			<div id="measureToolsPanel" style="display: none; position:absolute; top:50px; right:10px; background:white; padding:8px; border:1px solid #62ba46; border-radius:5px;">
				<div  class="close-panel-header">
					<span id="measureToolsPanelHeaderSpan">Crtanje i mjerenje</span>
					<button id="measureToolsPanelCloseButton" class="close-panel-button">✖</button>
				</div>
				
				<div style="display: flex; gap: 5px;">
					<div class="ol-control ol-unselectable" style="pointer-events: auto; position:relative;"><button title="Nacrtaj/Izmjeri točku" id="measurePointsButton" style="padding:2px; width:1.5em; height:1.5em; background: white; display: flex; align-items: center; justify-content: center;"><img id="measurePointsButtonImg" src="icons/thumbtack-solid.svg" alt="Nacrtaj/Izmjeri točku" width="15px" height="15px"/></button></div>
					<div class="ol-control ol-unselectable" style="pointer-events: auto; position:relative;"><button title="Nacrtaj/Izmjeri liniju" id="measureLinesButton" style="padding:2px; width:1.5em; height:1.5em; background: white; display: flex; align-items: center; justify-content: center;"><img id="measureLinesButtonImg" src="icons/slash-solid.svg" alt="Nacrtaj/Izmjeri liniju" width="15px" height="15px" /></button></div>
					<div class="ol-control ol-unselectable" style="pointer-events: auto; position:relative;"><button title="Nacrtaj/Izmjeri poligon" id="measurePolygonsButton" style="padding:2px; width:1.5em; height:1.5em; background: white; display: flex; align-items: center; justify-content: center;"><img id="measurePolygonsButtonImg" src="icons/draw-polygon-solid.svg" alt="Nacrtaj/Izmjeri poligon" width="15px" height="15px" /></button></div>
					<div class="ol-control ol-unselectable" style="pointer-events: auto; position:relative;"><button title="Izbriši označene" id="measureDeleteSelectedButton" style="padding:2px; width:1.5em; height:1.5em; background: white; display: flex; align-items: center; justify-content: center;"><img id="measureDeleteSelectedButtonImg" src="icons/eraser-solid.svg" alt="Izbriši označene" width="15px" height="15px" /></button></div>
					<div class="ol-control ol-unselectable" style="pointer-events: auto; position:relative;"><button title="Izbriši sve" id="measureDeleteAllButton" style="padding:2px; width:1.5em; height:1.5em; background: white; display: flex; align-items: center; justify-content: center;"><img id="measureDeleteAllButtonImg" src="icons/trash-solid.svg" alt="Izbriši sve" width="15px" height="15px" /></button></div>
					<div class="ol-control ol-unselectable" style="pointer-events: auto; position:relative;"><button title="Dodaj iz KML" id="measureUploadKMLButton" style="padding:2px; width:1.5em; height:1.5em; background: white; display: flex; align-items: center; justify-content: center;"><img id="measureUploadKMLButtonImg" src="icons/file-arrow-up-solid.svg" alt="Dodaj iz KML" width="15px" height="15px" /></button></div>
					<div class="ol-control ol-unselectable" style="pointer-events: auto; position:relative;"><button title="Preuzmi KML" id="measureDownloadKMLButton" style="padding:2px; width:1.5em; height:1.5em; background: white; display: flex; align-items: center; justify-content: center;"><img id="measureDownloadKMLButtonImg" src="icons/download-solid.svg" alt="Preuzmi KML" width="15px" height="15px" /></button></div>
				</div>
				<div style="margin-top: 5px;">
					<label id="showSegmentLengthsLabel" style="color:#666666; display: flex; align-items: center; gap:5px">
						<input type="checkbox" id="showSegmentLengthsCheckbox" checked/>
						<span id="showSegmentLengthsSpan">Prikaži duljine segmenata</span>
					</label>
				</div>
				<div style="margin-top: 5px;">
					<label id="showMeasurementsLabel" style="color:#666666; display: flex; align-items: center; gap:5px">
						<input type="checkbox" id="showMeasurementsCheckbox" checked/>
						<span id="showMeasurementsSpan">Prikaži izmjere</span>
					</label>
				</div>
			</div>
			
			
			
			
			<!-- Bottom Panel -->
			<div id="bottomPanel" class="bottomPanel">
				<div id="bottomPanelContainer">
					<img id="changeCrsImg" src="icons/globe-solid.svg" title="Promijeni koordinativni sustav" alt="Promijeni koordinativni sustav" width="20" height="20" />
					<a id="pointerCoordinatesLink" href="#" title="Otvori u Google Mapsu" target="_blank">WGS84:</a>
				</div>
			</div>

					
					<!--<div id="basemap-selector">
						<label for="basemaps">Pozadinski sloj:</label>
						<select id="basemaps">
							<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2011/wms">Ortofoto 2011</option>
							<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2014-2016/wms">Ortofoto 2014-2016</option>
							<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2017_2018/wms">Ortofoto 2017-2018</option>
							<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2019_2020/wms">Ortofoto 2019-2020</option>
							<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2021_2022/wms">Ortofoto 2021-2022</option>
						</select>
					</div>
					<div id="overbasemap-selector">
						<label for="overbasemaps">Dodatni sloj:</label>
						<select id="overbasemaps">
							<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2011/wms">Ortofoto 2011</option>
							<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2014-2016/wms">Ortofoto 2014-2016</option>
							<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2017_2018/wms">Ortofoto 2017-2018</option>
							<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2019_2020/wms">Ortofoto 2019-2020</option>
							<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2021_2022/wms">Ortofoto 2021-2022</option>
						</select>
					</div>-->	
				
					<!--<div id="basemap-selector">
						<label for="basemaps">Pozadinski sloj:</label>
						<select id="basemaps">
							<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2011/wms">Ortofoto 2011</option>
							<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2014-2016/wms">Ortofoto 2014-2016</option>
							<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2017_2018/wms">Ortofoto 2017-2018</option>
							<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2019_2020/wms">Ortofoto 2019-2020</option>
							<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2021_2022/wms">Ortofoto 2021-2022</option>
						</select>
					</div>
					<div id="overbasemap-selector">
						<label for="overbasemaps">Dodatni sloj:</label>
						<select id="overbasemaps">
							<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2011/wms">Ortofoto 2011</option>
							<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2014-2016/wms">Ortofoto 2014-2016</option>
							<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2017_2018/wms">Ortofoto 2017-2018</option>
							<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2019_2020/wms">Ortofoto 2019-2020</option>
							<option value="https://geoportal.dgu.hr/services/inspire/orthophoto_2021_2022/wms">Ortofoto 2021-2022</option>
						</select>
					</div>-->
				
			<div style="position:absolute; top:0px; left:0px; z-index:5000; background:white" id="comp-l61ukxrf" class="comp-l61ukxrf wixui-vector-image">
				<a id="logoLink" data-testid="linkElement" title="Park šuma Marjan" href="https://www.marjan-parksuma.hr" target="_blank">
					<div data-testid="svgRoot-comp-l61ukxrf" style="display: flex; align-items: center; justify-content: center; height: 100%;"><!--?xml version="1.0" encoding="UTF-8"?-->
						<svg preserveAspectRatio="xMidYMid meet" data-bbox="0 0 49 49" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 49 49" height="49" width="49" data-type="color" role="presentation" aria-hidden="true" aria-label="">
							<g>
								<path fill="#62BA46" d="M49.044 0H0v49h49.044V0Z" data-color="1"></path>								
								<path fill="#ffffff" d="M24.55 11.618h-.771v3.921h.77v-3.921Z" data-color="3"></path>
								<path fill="#ffffff" d="M23.779 11.85V9.244l3.175-.703v2.604l-3.175.703Zm.77-1.991v1.03l1.635-.361V9.497l-1.635.362Z" data-color="3"></path>
								<path fill="#ffffff" d="M38.869 31.605h-.77v-2.718l-1.214-1.284-1.116 1.275v1.713h-2.653v-1.717l-2.123-1.498-1.95 1.49v1.342h-.77v-1.725l2.703-2.058 2.91 2.05v1.346h1.112v-1.233l1.862-2.125 2.009 2.12v3.022Z" data-color="3"></path>
								<path fill="#ffffff" d="M22.532 29.745h-.766v-2.302h-3.13v.96h-.77v-1.73h4.666v3.072Z" data-color="3"></path>
								<path fill="#ffffff" d="M24.933 29.358H20.77v.77h4.162v-.77Z" data-color="3"></path>
								<path fill="#ffffff" d="M27.54 30.191h-.767v-1.88h-1.836v1.43h-.77v-2.2h3.373v2.65Z" data-color="3"></path>
								<path fill="#ffffff" d="M38.486 32.8H10.108v.77h28.378v-.77Z" data-color="3"></path>
								<path fill="#ffffff" d="M38.793 25.369c-2.594-.93-5.091-3.164-7.505-5.327-2.573-2.306-5.007-4.482-6.995-4.482-2.077 0-5 2.571-7.821 5.054-2.085 1.839-4.246 3.737-6.191 4.734l-.35-.686c1.862-.951 3.984-2.82 6.035-4.624 3.066-2.698 5.964-5.248 8.331-5.248 2.283 0 4.822 2.273 7.51 4.675 2.358 2.113 4.8 4.297 7.252 5.176l-.266.728Z" data-color="3"></path>
								<path fill="#ffffff" d="M33.752 37.525c-.724 0-1.461-.252-2.24-.521-.809-.278-1.647-.569-2.49-.569-.686 0-1.41.249-2.177.514-.821.282-1.676.576-2.552.576-.876 0-1.727-.294-2.552-.576-.767-.265-1.491-.514-2.178-.514-.842 0-1.676.287-2.489.569-.779.269-1.52.521-2.24.521a11.25 11.25 0 0 1-4.646-1.026c-.084-.038-.139-.064-.172-.076.004 0 .037.012.088.012v-.77c.105 0 .177.034.392.127.598.265 2.186.963 4.333.963.594 0 1.272-.231 1.993-.48.867-.298 1.768-.61 2.737-.61.817 0 1.634.282 2.43.556.763.26 1.554.534 2.3.534.75 0 1.537-.273 2.3-.534.791-.274 1.612-.556 2.43-.556.968 0 1.87.312 2.737.61.716.249 1.394.48 1.992.48 2.696 0 4.026-.513 4.043-.517l.287.715c-.055.025-1.458.572-4.326.572Z" data-color="3"></path>
								<path fill="#ffffff" d="M33.752 40.458c-.724 0-1.461-.252-2.24-.522-.809-.277-1.647-.568-2.49-.568-.686 0-1.41.249-2.177.514-.821.282-1.676.576-2.552.576-.876 0-1.727-.294-2.552-.576-.767-.265-1.491-.514-2.178-.514-.842 0-1.676.286-2.489.568-.779.27-1.52.522-2.24.522-2.313 0-4.01-.745-4.646-1.027-.084-.037-.139-.063-.172-.075.004 0 .037.012.088.012v-.77c.105 0 .177.034.392.127.598.265 2.186.963 4.333.963.594 0 1.272-.231 1.993-.48.867-.298 1.768-.61 2.737-.61.817 0 1.634.282 2.43.556.763.26 1.554.534 2.3.534.75 0 1.537-.273 2.3-.534.791-.274 1.612-.556 2.43-.556.968 0 1.87.312 2.737.61.716.249 1.394.48 1.992.48 2.746 0 5.168-.53 5.193-.534l.168.749c-.1.025-2.522.555-5.357.555Z" data-color="3"></path>
								<path fill="#ffffff" d="M25.75 27.927h-.767V25.23l-1.617-1.182-1.554 1.132v1.72h-.771v-2.116l2.329-1.687 2.38 1.746v3.084Z" data-color="3"></path>
								<path fill="#ffffff" d="M29.945 28.15h-.771v-1.615H26.98v1.392h-.771v-2.163h3.736v2.386Z" data-color="3"></path>
								<path fill="#ffffff" d="M17.386 31.42h-2.843v-1.292h-4.435v-.77h5.201v1.292h1.306v-2.634h2.632v.77h-1.861v2.634Z" data-color="3"></path>
							</g>
						</svg>
					</div>
				</a>
			</div>
		</div>
		<!--<script src="https://cdn.jsdelivr.net/npm/ol@v10.3.1/dist/ol.js"></script>-->
		<script src="ol_v10.3.1/ol.js"></script>
		<script src="proj4js-2.15.0/proj4.js"></script>
		<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>-->
		<script>
		
			proj4.defs("EPSG:3765","+proj=tmerc +lat_0=0 +lon_0=16.5 +k=0.9999 +x_0=500000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +type=crs");
			ol.proj.proj4.register(proj4);
			const projection = ol.proj.get('EPSG:3765');
			const worldExtent4326 = [13.0, 41.62, 19.43, 46.54]; 
			// Apply the transformed extent
			//projection.setExtent(worldExtent3765);
			projection.setWorldExtent(worldExtent4326);
			projection.setExtent([208311.05, 4608969.52, 744179.92, 5161549.72]);
			
			
			document.getElementById('downloadDataPanelCloseButton').addEventListener('click', function () {
				switchPanelState('downloadDataButton');
			});
			document.getElementById('layersPanelCloseButton').addEventListener('click', function () {
				switchPanelState('layerMenuButton');
			});
			document.getElementById('measureToolsPanelCloseButton').addEventListener('click', function () {
				switchPanelState('measureToolsButton');
			});
			document.getElementById('gotoCoordinatesPanelCloseButton').addEventListener('click', function () {
				switchPanelState('gotoCoordinatesPanelButton');
			});
			
			
			document.getElementById('reportIssuePanelCloseButton').addEventListener('click', function () {
				document.getElementById('reportIssuePanel').style.display = 'none';
			});
			
				
				
			// Function to handle button click events
			// Function to handle button click events
			function switchPanelState(clickedButtonId) {
				const layerMenu = document.getElementById('layersPanel');
				const measureToolsPanel = document.getElementById('measureToolsPanel');
				const gotocoordinatesPanel = document.getElementById('gotoCoordinatesPanel');
				const downloaddataPanel = document.getElementById('downloadDataPanel');

				// Perform action based on clicked button's ID
				if (clickedButtonId === 'layerMenuButton') {
					// If layer menu is open, close it; otherwise, open it
					if (layerMenu.style.display === 'block') {
						layerMenu.style.display = 'none';
					} else {
						layerMenu.style.display = 'block';
						// Close other panels
						measureToolsPanel.style.display = 'none';
						gotocoordinatesPanel.style.display = 'none';
						downloaddataPanel.style.display = 'none';
						rectangleLayer.setVisible(false);
					}
				} else if (clickedButtonId === 'measureToolsButton') {
					// If measure tools panel is open, close it; otherwise, open it
					if (measureToolsPanel.style.display === 'block') {
						measureToolsPanel.style.display = 'none';
					} else {
						measureToolsPanel.style.display = 'block';
						// Close other panels
						layerMenu.style.display = 'none';
						gotocoordinatesPanel.style.display = 'none';
						downloaddataPanel.style.display = 'none';
						rectangleLayer.setVisible(false);
					}
				} else if (clickedButtonId === 'gotoCoordinatesPanelButton') {
					// If goto coordinates panel is open, close it; otherwise, open it
					if (gotocoordinatesPanel.style.display === 'block') {
						gotocoordinatesPanel.style.display = 'none';
					} else {
						gotocoordinatesPanel.style.display = 'block';
						// Close other panels
						layerMenu.style.display = 'none';
						measureToolsPanel.style.display = 'none';
						downloaddataPanel.style.display = 'none';
						rectangleLayer.setVisible(false);
					}
				} else if (clickedButtonId === 'downloadDataButton') {
					// If download data panel is open, close it; otherwise, open it
					if (downloaddataPanel.style.display === 'block') {
						downloaddataPanel.style.display = 'none';
						rectangleLayer.setVisible(false);
					} else {
						downloaddataPanel.style.display = 'block';
						// Close other panels
						layerMenu.style.display = 'none';
						measureToolsPanel.style.display = 'none';
						gotocoordinatesPanel.style.display = 'none';

						// If no features exist, create a rectangle
						if (rectangleSource.getFeatures().length == 0) {
							const mapCenter = map.getView().getCenter();
							const rectangleExtent = [mapCenter[0] - 25, mapCenter[1] - 25, mapCenter[0] + 25, mapCenter[1] + 25];
							const rectangle = new ol.Feature(ol.geom.Polygon.fromExtent(rectangleExtent));

							rectangle.setStyle(new ol.style.Style({
								stroke: new ol.style.Stroke({ color: 'black', width: 2 }),
								fill: new ol.style.Fill({ color: 'rgba(255, 0, 0, 0.2)' })
							}));

							rectangleSource.addFeature(rectangle);
						}
						rectangleLayer.setVisible(true);
					}
				}
			}
			
			// Add event listeners to buttons
			document.getElementById('layerMenuButton').addEventListener('click', function () {
				switchPanelState('layerMenuButton');
			});

			document.getElementById('measureToolsButton').addEventListener('click', function () {
				switchPanelState('measureToolsButton');
			});

			document.getElementById('gotoCoordinatesPanelButton').addEventListener('click', function () {
				switchPanelState('gotoCoordinatesPanelButton');
			});

			document.getElementById('downloadDataButton').addEventListener('click', function () {
				switchPanelState('downloadDataButton');
			});
			
			/*document.getElementById('layerMenuButton').addEventListener('click', function () {
				const layerMenu = document.getElementById('layersPanel');
				const measureToolsPanel = document.getElementById('measureToolsPanel');
				const gotocoordinatesPanel = document.getElementById('gotoCoordinatesPanel');
				const downloaddataPanel = document.getElementById('downloadDataPanel');

				// Check if the measure tools panel is open and close it if it is
				if (measureToolsPanel.style.display === 'block') {
					measureToolsPanel.style.display = 'none';
				}
				if (gotocoordinatesPanel.style.display === 'block') {
					gotocoordinatesPanel.style.display = 'none';
				}
				
				if (downloaddataPanel.style.display === 'block') {
					downloaddataPanel.style.display = 'none';
					rectangleLayer.setVisible(false);
				}

				// Toggle the layer menu
				layerMenu.style.display = (layerMenu.style.display === 'block') ? 'none' : 'block';
			});

			document.getElementById('measureToolsButton').addEventListener('click', function () {
				const layerMenu = document.getElementById('layersPanel');
				const measureToolsPanel = document.getElementById('measureToolsPanel');
				const gotocoordinatesPanel = document.getElementById('gotoCoordinatesPanel');
				const downloaddataPanel = document.getElementById('downloadDataPanel');

				// Check if the layer menu is open and close it if it is
				if (layerMenu.style.display === 'block') {
					layerMenu.style.display = 'none';
				}
				if (gotocoordinatesPanel.style.display === 'block') {
					gotocoordinatesPanel.style.display = 'none';
				}
				if (downloaddataPanel.style.display === 'block') {
					downloaddataPanel.style.display = 'none';
					rectangleLayer.setVisible(false);
				}

				// Toggle the measure tools panel
				measureToolsPanel.style.display = (measureToolsPanel.style.display === 'block' || measureToolsPanel.style.display === '') ? 'none' : 'block';
			});
			
			
			document.getElementById('gotoCoordinatesPanelButton').addEventListener('click', function () {
				const layerMenu = document.getElementById('layersPanel');
				const measureToolsPanel = document.getElementById('measureToolsPanel');
				const gotocoordinatesPanel = document.getElementById('gotoCoordinatesPanel');
				const downloaddataPanel = document.getElementById('downloadDataPanel');

				// Check if the layer menu is open and close it if it is
				if (layerMenu.style.display === 'block') {
					layerMenu.style.display = 'none';
				}
				
				if (measureToolsPanel.style.display === 'block') {
					measureToolsPanel.style.display = 'none';
				}
				if (downloaddataPanel.style.display === 'block') {
					downloaddataPanel.style.display = 'none';
					rectangleLayer.setVisible(false);
				}

				// Toggle the measure tools panel
				gotocoordinatesPanel.style.display = (gotocoordinatesPanel.style.display === 'block' || gotocoordinatesPanel.style.display === '') ? 'none' : 'block';
			});
			
			
			
			
			
			
			
			
			
			document.getElementById('downloadDataButton').addEventListener('click', function () {
				const layerMenu = document.getElementById('layersPanel');
				const measureToolsPanel = document.getElementById('measureToolsPanel');
				const gotocoordinatesPanel = document.getElementById('gotoCoordinatesPanel');
				const downloaddataPanel = document.getElementById('downloadDataPanel');

				// Check if the layer menu is open and close it if it is
				if (layerMenu.style.display === 'block') {
					layerMenu.style.display = 'none';
				}
				
				if (measureToolsPanel.style.display === 'block') {
					measureToolsPanel.style.display = 'none';
				}

				if (gotocoordinatesPanel.style.display === 'block') {
					gotocoordinatesPanel.style.display = 'none';
				}
				//downloaddataPanel.style.display= 'block';
				const status=downloaddataPanel.style.display;
				if (status==='none'){
					if (rectangleSource.getFeatures().length==0)
					{
						const mapCenter=map.getView().getCenter();
						const rectangleExtent = [mapCenter[0]-50,mapCenter[1]-50,mapCenter[0]+50,mapCenter[1]+50];
						const rectangle = new ol.Feature(ol.geom.Polygon.fromExtent(rectangleExtent) );
						
						rectangle.setStyle(new ol.style.Style({
							stroke: new ol.style.Stroke({ color: 'black', width: 2 }),
							fill: new ol.style.Fill({ color: 'rgba(255, 0, 0, 0.2)' })
						}));
						
						rectangleSource.addFeature(rectangle);
					}
					rectangleLayer.setVisible(true);
					downloaddataPanel.style.display = 'block';
				}
				else{
					rectangleLayer.setVisible(false);
					downloaddataPanel.style.display = 'none';
				}
			});*/
				
			
			
			function zoomToLayerExtentOrFeature(zoomToLayer){
				try{
					const minZoom = 12;
					const layerExtent=zoomToLayer.getSource().getExtent();
					if (Math.abs(layerExtent[0]-layerExtent[2])<50 && Math.abs(layerExtent[1]-layerExtent[3])<50){
						const center = ol.extent.getCenter(layerExtent);
				        map.getView().setCenter(center);
				        map.getView().setZoom(minZoom);
					}
					else{
						map.getView().fit(layerExtent, {
							size: map.getSize(),
							duration: 500,
							padding: [50, 50, 50, 50] // Prevents zooming too close to the edges
						});
					}
				}
				catch{}
			}
			
			

			document.getElementById('zoomToExtentGrafikaButton').addEventListener('click', function () {
				zoomToLayerExtentOrFeature(measureLayer);
			});

			document.getElementById('zoomToExtentIdiNaKoordinateButton').addEventListener('click', function () {
				zoomToLayerExtentOrFeature(goToCoordsLayer);				
			});

			
			//const marjanGisServerUrl='http://192.168.201.2:8080/';
			const marjanGisServerUrl='http://188.245.172.6:8080/';
		
		
			// Create a function to create a WMS layer
			function createWmsLayer(layerType) {
				if (layerType === "OSM") {
					return new ol.layer.Tile({
						source: new ol.source.OSM({crossOrigin:'anonymous'})// OpenStreetMap Tile Layer						
					});
				}
				const ak="authKey=fee6e8df-d92b-4413-bef0-e1900c88286d";
				var layername="OI.OrthoimageCoverage";
				let attrib='<a target="_blank" href="https://www.marjan-parksuma.hr/">Park šuma Marjan</a>';
				let url;
				if (layerType === "TK25")
				{
					url='https://geoportal.dgu.hr/services/auth/tk/wms'+"?"+ak;
					layername='tk:TK25';
					attrib='<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>';
				}
				if (layerType === "HOK")
				{
					url='https://geoportal.dgu.hr/services/auth/hok/wms'+"?"+ak;
					layername='HOK5';
					attrib='<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>';
				}
				if (layerType === "DOF_2011")
				{	
					url='https://geoportal.dgu.hr/services/auth/inspire/orthophoto_2011/wms'+"?"+ak;
					layername='OrthoImagery';
					attrib='<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>';
				}
				if (layerType === "DOF_2014_2016")
				{
					url='https://geoportal.dgu.hr/services/auth/inspire/orthophoto_2014-2016/wms'+"?"+ak;
					layername='OI.OrthoImagery';
					attrib='<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>';
				}
				if (layerType === "DOF_2017_2018") {
					layername="OI.OrthoimageCoverage";
					url='https://geoportal.dgu.hr/services/auth/inspire/orthophoto_2017_2018/wms'+"?"+ak;
					attrib='<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>';
				}
				if (layerType === "DOF_2019_2020") {
					layername="OI.OrthoimageCoverage";
					url='hhttps://geoportal.dgu.hr/services/auth/inspire/orthophoto_2019_2020/wms'+"?"+ak;
					attrib='<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>';
				}
				if (layerType === "DOF_2021_2022") {
					layername="OI.OrthoimageCoverage";
					url='https://geoportal.dgu.hr/services/auth/inspire/orthophoto_2021_2022/wms'+"?"+ak;
					attrib='<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>';
				}
				if (layerType === "DOF_Lidar_2023") {
					layername="OI.OrthoimageCoverage";
					url='https://geoportal.dgu.hr/services/auth/inspire/orthophoto_2023/wms'+"?"+ak;
					attrib='<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>';
				}				
				if (layerType === "DMR_COLOR")
				{
					url='https://geoportal.dgu.hr/services/sla/dmr/wms'+"?"+ak;
					layername='DMR_COLOR';
					attrib='<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>';
				}
				if (layerType === "DMR_BW")
				{
					url='https://geoportal.dgu.hr/services/sla/dmr/wms'+"?"+ak;
					layername='DMR_BW';
					attrib='<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>';
				}
				if (layerType === "DEM_25m")
				{
					url='https://geoportal.dgu.hr/services/sla/dmr/wms'+"?"+ak;
					layername='DEM_25m';
					attrib='<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>';
				}
				if (layerType === "Adrese")
				{
					url='https://geoportal.dgu.hr/services/auth/inspire/ad/wms'+"?"+ak;
					layername='AD.Address';
					attrib='<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>';
				}
				if (layerType === "Zgrade")
				{
					url='https://geoportal.dgu.hr/services/auth/inspire/bu/wms'+"?"+ak;
					layername='BU.Building';
					attrib='<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>';
				}
				if (layerType === "CestovniPromet")
				{
					url='https://geoportal.dgu.hr/services/auth/inspire/tn/wms'+"?"+ak;
					layername='TN.RoadTransportNetwork.RoadArea';
					attrib='<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>';
				}
				if (layerType === "Marjan_orto_2024_5cm")
				{
					url=marjanGisServerUrl+'geoserver/MarjanOrtofoto2024/wms';
					layername='MarjanOrtofoto2024:Marjan_2024_ortofoto_5cm';
					attrib='<a target="_blank" href="https://www.marjan-parksuma.hr/">Marjan park šuma</a>';
				}
				if (layerType === "Marjan_orto_2024_10cm")
				{
					url=marjanGisServerUrl+'geoserver/MarjanOrtofoto2024/wms';
					layername='MarjanOrtofoto2024:Marjan_2024_ortofoto_10cm';
					attrib='<a target="_blank" href="https://www.marjan-parksuma.hr/">Marjan park šuma</a>';
				}
				if (layerType === "Marjan_hillshade_2024_50cm")
				{
					url=marjanGisServerUrl+'geoserver/MarjanOrtofoto2024/wms';
					layername='MarjanOrtofoto2024:Marjan_2024_DSM_50cm_hillshade_multidirectional';
					attrib='<a target="_blank" href="https://www.marjan-parksuma.hr/">Marjan park šuma</a>';
				}
				if (layerType === "Marjan_orto_2025_1_5cm")
				{
					url=marjanGisServerUrl+'geoserver/MarjanOrtofoto2025/wms';
					layername='MarjanOrtofoto2025:Marjan_2025_1_ortofoto_5cm';
					attrib='<a target="_blank" href="https://www.marjan-parksuma.hr/">Marjan park šuma</a>';
				}
				if (layerType === "Marjan_hillshade_2025_1_50cm")
				{
					url=marjanGisServerUrl+'geoserver/MarjanOrtofoto2025/wms';
					layername='MarjanOrtofoto2025:Marjan_2025_1_DSM_50cm_hillshade_multidirectional';
					attrib='<a target="_blank" href="https://www.marjan-parksuma.hr/">Marjan park šuma</a>';
				}
				if (layerType.includes("Marjan")){
					return new ol.layer.Tile({
						source: new ol.source.TileWMS({
							attributions: attrib,
							minZoom: 8,      // Minimum zoom level for the layer to be visible
							maxZoom: 14, 
							url: url,
							params: {
								'LAYERS': layername, // Correct layer name from GetCapabilities
								'TILED': false,
								'CRS': 'EPSG:3765',
								//crossOrigin: 'anonymous'
							},
							serverType: 'geoserver',
							//crossOrigin: 'anonymous'
						})
					});
				}
				else{
					let el=new ol.layer.Tile({
						source: new ol.source.TileWMS({
							attributions: attrib,
							minZoom: 8,      // Minimum zoom level for the layer to be visible
							maxZoom: 14, 
							url: url,
							params: {
								'LAYERS': layername, // Correct layer name from GetCapabilities
								'TILED': false,
								'CRS': 'EPSG:3765',
								crossOrigin: 'anonymous'
							},
							serverType: 'geoserver',
							//crossOrigin: 'anonymous'
						})
					});
					return el;
				}
			}

			async function getWMTSCapabilities(url) {
				try {
					const response = await fetch(url); // Use await here
					if (!response.ok) {
						const errorText = await response.text();
						throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
					}

					const text = await response.text();
					const parser = new ol.format.WMTSCapabilities();
					const capabilities = parser.read(text);

					if (!capabilities) {
						throw new Error("Invalid WMTS Capabilities document");
					}

					return capabilities; // Return the capabilities

				} catch (error) {
					//console.error("Error fetching or parsing WMTS Capabilities:", error);
					return null;
				}
			}

			async function createWmtsLayer(layerType) {
				if (layerType === "OSM") {
					return new ol.layer.Tile({
						source: new ol.source.OSM({crossOrigin:'anonymous'}), // OpenStreetMap Tile Layer
					});
				}
				const ak="authKey=fee6e8df-d92b-4413-bef0-e1900c88286d";
				let layername;
				let url;
				let attrib='<a target="_blank" href="https://www.marjan-parksuma.hr/">Park šuma Marjan</a>';
				if (layerType === "TK25") {
					layername='TK25';
					url='https://geoportal.dgu.hr/services/sla/dof_hok_tk/wmts'+"?"+ak;
					attrib='<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>';				
				}
				if (layerType === "HOK") {
					layername='HOK5';
					url='https://geoportal.dgu.hr/services/sla/dof_hok_tk/wmts'+"?"+ak;
					attrib='<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>';
				}
				if (layerType === "DOF_2011") {
					layername='DOF5_2011';
					url='https://geoportal.dgu.hr/services/sla/dof_hok_tk/wmts'+"?"+ak;
					attrib='<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>';
				}
				if (layerType === "DOF_2014_2016") {
					layername='DOF5_2014_2016';
					url='https://geoportal.dgu.hr/services/sla/dof_hok_tk/wmts'+"?"+ak;
					attrib='<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>';
				}
				if (layerType === "DOF_2017_2018") {
					layername='DOF5_2017_2018';
					url='https://geoportal.dgu.hr/services/sla/orthophoto_2017_2018/wmts'+"?"+ak;
					attrib='<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>';
				}
				if (layerType === "DOF_2019_2020") {
					layername='DOF5_2019_2020';
					url='https://geoportal.dgu.hr/services/sla/orthophoto_2019_2020/wmts'+"?"+ak;
					attrib='<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>';
				}
				if (layerType === "DOF_2021_2022") {
					layername='DOF5_2021_2022';
					url='https://geoportal.dgu.hr/services/sla/orthophoto_2021_2022/wmts'+"?"+ak;
					attrib='<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>';
				}
				if (layerType === "DOF_Lidar_2023") {
					layername='DOF5_2023';
					url='https://geoportal.dgu.hr/services/sla/orthophoto_2023/wmts'+"?"+ak;
					attrib='<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>';
				}
				
				
				if (layerType === "Marjan_orto_2024_5cm" || layerType === "Marjan_hillshade_2024_50cm" || layerType === "Marjan_orto_2025_1_5cm" || layerType === "Marjan_hillshade_2025_1_50cm")
				{
					if (layerType === "Marjan_orto_2024_5cm" ){
						layername='MarjanOrtofoto2024:Marjan_2024_ortofoto_5cm';
					}
					else if (layerType === "Marjan_hillshade_2024_50cm"){
						layername='MarjanOrtofoto2024:Marjan_2024_DSM_50cm_hillshade_combined';
					}
					else if (layerType === "Marjan_orto_2025_1_5cm" ){
						layername='MarjanOrtofoto2025:Marjan_2025_1_ortofoto_5cm';
					}
					else if (layerType === "Marjan_hillshade_2025_1_50cm"){
						layername='MarjanOrtofoto2025:Marjan_2025_1_DSM_50cm_hillshade_combined';
					}
					
					url=marjanGisServerUrl+'geoserver/gwc/service/wmts?service=wmts&version=1.1.1';					
					attrib='<a target="_blank" href="https://www.marjan-parksuma.hr/">Marjan park šuma</a>';
				
					/*const resolutions = [
						1931.333812189312, 965.666906094656, 482.833453047328, 241.416726523664,
						120.708363261832, 60.354181630916, 30.177090815458, 15.088545407729,
						7.5442727038645, 3.77213635193225, 1.886068175966125, 0.9430340879830625,
						0.4715170439915313, 0.2357585219957656, 0.1178792609978828, 0.0589396304989414,
						0.0294698152494707, 0.0147349076247354, 0.0073674538123677, 0.0036837269061838,
						0.0018418634530919, 0.000920931726546, 0.000460465863273, 0.0002302329316365,
						0.0001151164658182, 0.0000575582329091, 0.0000287791164546, 0.0000143895582273,
						0.0000071947791136, 0.0000035973895568, 0.0000017986947784
					]; // Reverse for OpenLayers order

							const matrixIds = resolutions.map((_, i) => `My_EPSG3765:256x256:${i}`);

							// Define WMTS TileGrid
							const tileGrid = new ol.tilegrid.WMTS({
						origin: [247020.52671340803, 5160175.80631312], // Top-left from GeoServer bounds
						resolutions: resolutions,
						matrixIds: matrixIds,
						tileSize: [256, 256]
					});*/
				
				
					const resolutions = [
						2158.5164062500007, 1079.2582031250004, 539.6291015625002, 269.8145507812501, 
						134.90727539062505, 67.45363769531252, 33.72681884765626, 16.86340942382813, 
						8.431704711914065, 4.215852355957033, 2.1079261779785163, 1.0539630889892582, 
						0.5269815444946291, 0.2634907722473145, 0.1317453861236573, 0.0658726930618286,
						0.0329363465309143, 0.0164681732654572, 0.0082340866327286
					]; // Reverse for OpenLayers order

					const matrixIds = resolutions.map((_, i) => `EPSG3765:256:${i}`);

					// Define WMTS TileGrid
					const tileGrid = new ol.tilegrid.WMTS({
						extent: [208311.05, 4608969.52, 744179.92, 5161549.72], // Top-left from GeoServer bounds
						resolutions: resolutions,
						matrixIds: matrixIds,
						tileSize: [256, 256]
					});

					// Define WMTS Layer
					const wmtsLayer = new ol.layer.Tile({
						source: new ol.source.WMTS({
							url: marjanGisServerUrl+'geoserver/gwc/service/wmts?',
							layer: layername,
							matrixSet: 'EPSG3765:256', // Confirmed correct from QGIS
							format: 'image/png',
							projection: projection,
							tileGrid: tileGrid,
							style: '',
							requestEncoding: 'KVP',
							//crossOrigin: 'anonymous'
						})
					});
					return wmtsLayer;
				}
				
				
				let wmtsCapabilities = await getWMTSCapabilities(url + "&request=GetCapabilities"); // Await here!

				if (wmtsCapabilities) { // Check wmtsCapabilities *here*
					//let matrixSet='EPSG3765:1024x1024';
					console.log(wmtsCapabilities);
					let matrixSet='EPSG:4326';
					if (layerType === "Marjan_hillshade_2024_2m"){
						matrixSet='EPSG:4326';
					}
					const options = ol.source.WMTS.optionsFromCapabilities(wmtsCapabilities, { //Use wmtsCapabilities
						layer: layername,
						matrixSet: matrixSet,
						crossOrigin: 'anonymous'
					});
					console.log(options);
					options.attributions= attrib;
					const layer = new ol.layer.Tile({
						source: new ol.source.WMTS(options),
					});
					//layer.setZIndex(0); // Set z-index here or later
					return layer; // Return the layer
				} else {
					return null;
				}
			}
			
			async function initializeAndAddBasemapLayer(layerType, layerService) {
				try {
					let bLayer;
					if (layerService=='WMTS'){
						bLayer = await createWmtsLayer(layerType); // Await here!
					}
					else{
						bLayer = createWmsLayer(layerType);
					}
					if (bLayer){
						try{
							if (basemapLayer)
							{
								map.removeLayer(basemapLayer);
							}
						}
						catch{}
						basemapLayer = bLayer;
						basemapLayer.setZIndex(0);				
						map.addLayer(basemapLayer);
						basemapLayer.setZIndex(0);
					}
				}catch (error) {
					console.error("Map initialization error:", error);
				}
			}
			
			async function initializeAndAddOverbasemapLayer(layerType, layerService) {
				try{
					let overLayer;
					if (layerService=='WMTS'){
						overLayer = await createWmtsLayer(layerType); // Await here!
					}
					else{
						overLayer = createWmsLayer(layerType);
					}
					if (overLayer) {
						try{
							if (overbasemapLayer)
							{
								map.removeLayer(overbasemapLayer);
							}
						}
						catch{}
							
						overbasemapLayer = overLayer;
						overbasemapLayer.on('prerender', clipLayer);
						overbasemapLayer.on('postrender', restoreLayer);
						overbasemapLayer.setZIndex(1);				
						map.addLayer(overbasemapLayer);
						overbasemapLayer.setZIndex(1);
						const opacity=Number(document.getElementById('overbasemapVisibilitySlider').value);
						if (!isNaN(opacity) && opacity >= 0 && opacity <= 1) { // Check if it's a valid number and within range.
							overbasemapLayer.setOpacity(opacity);
						} 						
					}				
				}catch (error) {
					console.error("Map initialization error:", error);
				}
			}
			
			const attributions = new ol.control.Attribution({
			  collapsible: false,
			});
			
			const view = new ol.View({
		                center: [492720, 4818800], // Example center in EPSG:3765
		                zoom: 10,
			        projection: projection, // Set the view projection
		        });
			
			const initialExtent=[490570,4817800,494771,4819888];
			
			// Initialize the map
			const map = new ol.Map({ // Make sure you have a map target
					target: 'map',  // Replace 'map' with the id of your map div
					controls: ol.control.defaults.defaults({ attribution: false }).extend([attributions]),
					view:view
			});
			
			map.getView().fit(initialExtent);
			
			let basemapLayer;
			let overbasemapLayer ;
			//console.log("mreza4");
			const mreza=new ol.layer.Graticule({
				showLabels: true,
				lonLabelFormatter: (lon) => lon.toFixed(4) + "°",  // Format longitude labels
				latLabelFormatter: (lat) => lat.toFixed(4) + "°",  // Format latitude labels
				wrapX: false,
				strokeStyle: new ol.style.Stroke({
					color: "rgba(0, 0, 255, 0.4)", // Blue grid lines
			        	width: 1
			    	})
			});

			
			// Add initial layer
			initializeAndAddBasemapLayer('TK25','WMTS');
			initializeAndAddOverbasemapLayer('DOF_Lidar_2023','WMTS');

			mreza.setMap(map);
			
			//Idi na koordinate
			const goToCoordsSource = new ol.source.Vector({crossOrigin:'anonymous'});

			const goToCoordsLayer = new ol.layer.Vector({
				source: goToCoordsSource,
				style: function (feature) {
					return goToCoordsStyle;
				},
			});
			goToCoordsLayer.setZIndex(21);
			map.addLayer(goToCoordsLayer);
			goToCoordsLayer.setZIndex(21);
			
			//goToCoordsLayeStyle sluzi za iscrtavanje featurea za sloj idi na koordinate
			const goToCoordsStyle = new ol.style.Style({
				text: new ol.style.Text({
					font: '14px Calibri,sans-serif',
					fill: new ol.style.Fill({
						color: 'rgba(255, 255, 255, 1)',
					}),
					backgroundFill: new ol.style.Fill({
						color: 'rgba(0, 0, 0, 0.7)',
					}),
					padding: [3, 3, 3, 3],
					textBaseline: 'bottom',
					offsetY: -15,
				}),
				image: new ol.style.RegularShape({
					radius: 6,
					points: 3,
					angle: Math.PI,
					displacement: [0, 6],
					fill: new ol.style.Fill({
						color: 'red',
					}),
				}),
			});

			document.getElementById('goToCoordsLayerVisibilityCheckbox').addEventListener("change", function () {				
				goToCoordsLayer.setVisible(this.checked);
			});
			
			document.getElementById('goToCoordsLayerVisibilitySlider').addEventListener('input', function () {
				const opacity = Number(this.value);

				if (!isNaN(opacity) && opacity >= 0 && opacity <= 1) { // Check if it's a valid number and within range.
					goToCoordsLayer.setOpacity(opacity);
				} else {
					console.error("Invalid opacity value:", this.value); // Debugging
				}
			});

			function validateCoordinateInput(element) {
				//const inputField = document.getElementById("myInput");
				//console.log(element);
				const inputValue =element.value;
				//console.log(inputValue);
				//const errorMessage = document.getElementById("gotoCoordinatesWarning");
				
				// Regex allowing up to two spaces between numbers
				const pattern = /^(\d*[.,]?\d+)( (\d*[.,]?\d+)){0,2}$/;
				
				if (!pattern.test(inputValue)) {
					//errorMessage.textContent = "";
					document.getElementById('gotoCoordinatesWarning').style.display='block';
					//element.classList.remove("invalid");
				  } else {
					//errorMessage.textContent = "Problem";
					document.getElementById('gotoCoordinatesWarning').style.display='none';
					//element.classList.add("invalid");
				  }
			}

			document.getElementById('XCoordinate').addEventListener("change", (event) => {
				validateCoordinateInput(event.target);;
			});
			
			document.getElementById('YCoordinate').addEventListener("change", (event) => {
				validateCoordinateInput(event.target);;
			});

			function is_number(s) {
				if (typeof s !== 'string') {  // Check if it's a string first (important!)
			    		return false;
			  	}
			
			  	if (s.trim() === "") { // Check for empty or whitespace-only strings
			    		return false;
			  	}
			
			  	// Attempt conversion to number (will handle both ints and floats)
			  	const n = Number(s);
			
			  	if (isNaN(n)) { // Check if it's Not a Number (NaN)
			    		return false;
			  	}
			  	return true;
			}

			function checkCoordinateValidity(element, isLongitude){
				let x=element.value.trim().replace(",",".");
				const pattern = /^(\d*[.,]?\d+)( (\d*[.,]?\d+)){0,2}$/;
				if (pattern.test(x)){
					const xSplit=x.split(" ").filter(word => word !== ""); 	
					let xCoord;
					if (xSplit.length==1){
						if (is_number(xSplit[0])){
							xCoord=Number(xSplit[0]);
							element.value=xSplit[0];
							return xCoord;
						}
						else{
							return null;
						}
					}
					//znaci da ima razmak, sto znaci da nije htrs96tm
					if (xSplit.length==2){
						if (xSplit[0].includes("."))
						{
							if (is_number(xSplit[0])){
								let minX=-90;
								if (isLongitude){
									minX=-180;
								}
								let dd=Number(xSplit[0]);
								if (dd>=minX && dd<=Math.abs(minX)){
									element.value=xSplit[0];
									xCoord=dd;
									return xCoord;
								}else{
									return null;
								}
							}
							else{
								return null;
							}
						}
						else{
							if (is_number(xSplit[0]) && is_number(xSplit[1])){
								let minX=-90;
								if (isLongitude){
									minX=-180;
								}
								let dd=Number(xSplit[0]);
								let mm=Number(xSplit[1]);
								if (dd>=minX && dd<=Math.abs(minX) && mm>=0 && mm<60){
									xCoord=dd+mm/60;
									element.value=xSplit[0]+" "+xSplit[1];
									return xCoord;
								}else{
									return null;
								}
							}
							else{
								return null;
							}
						}							
					}
					if (xSplit.length==3){
						if (xSplit[0].includes("."))
						{
							if (is_number(xSplit[0])){
								let minX=-90;
								if (isLongitude){
									minX=-180;
								}
								let dd=Number(xSplit[0]);
								if (dd>=minX && dd<=Math.abs(minX)){
									element.value=xSplit[0];
									xCoord=dd;
									return xCoord;
								}else{
									return null;
								}
							}
							else{
								return null;
							}
						}
						if (xSplit[1].includes(".")){
							if (is_number(xSplit[0]) && is_number(xSplit[1])){
								let minX=-90;
								if (isLongitude){
									minX=-180;
								}
								let dd=Number(xSplit[0]);
								let mm=Number(xSplit[1]);
								if (dd>=minX && dd<=Math.abs(minX) && mm>=0 && mm<60){
									xCoord=dd+mm/60;
									element.value=xSplit[0]+" "+xSplit[1];
									return xCoord;
								}else{										
									return null;
								}
							}
							else{
								return null;
							}
						}
						else{
							if (is_number(xSplit[0]) && is_number(xSplit[1]) && is_number(xSplit[2])){
								let minX=-90;
								if (isLongitude){
									minX=-180;
								}
								let dd=Number(xSplit[0]);
								let mm=Number(xSplit[1]);
								let ss=Number(xSplit[2]);
								if (dd>=minX && dd<=Math.abs(minX) && mm>=0 && mm<60 && ss>=0 && ss<60){
									xCoord=dd+mm/60+ss/3600;
									element.value=xSplit[0]+" "+xSplit[1]+" "+xSplit[2];
									return xCoord;
								}else{										
									return null;
								}
							}
							else{
								return null;
							}
						}
						
					}
					else
					{
						return null;
					}
				}
				else{
					//console.log("problem s formatom");
					return null;
				}
			}
			
			document.getElementById('gotoCoordinatesButton').addEventListener("click", function () {	
				let x=checkCoordinateValidity(document.getElementById('XCoordinate'), true);
				let y=checkCoordinateValidity(document.getElementById('YCoordinate'), false);
				if (x && y)
				{
					console.log(x);
					console.log(y);
					let epsg=null;
					if (x>=-180 && x<180 && y>=-90 && y<=90){
						epsg=4326;
					}
					else if (x>=208311.05 && x<744179.92 && y>=4608969.52 && y<5161549.72)
					{
						epsg=3765;					
					}
					if (epsg){
						document.getElementById('gotoCoordinatesWarning').style.display='none';
						let htrsCoords=null
						if (epsg===4326){
							htrsCoords=ol.proj.transform([x,y], 'EPSG:4326', projection);		
							console.log(htrsCoords);
						}
						else{
							htrsCoords=[x,y];						
						}		
						const htrsPointGeometry = new ol.geom.Point(htrsCoords);
	
						// Create a new feature with the point geometry
						const feature = new ol.Feature({
							geometry: htrsPointGeometry,
						    	name: 'Idi na koordinate',
						    	description: 'Idi na koordinate'
						  });
						  
						let pointLabelStyle = feature.getStyle();
						if (!pointLabelStyle) {
							pointLabelStyle = goToCoordsStyle.clone();
							//feature.setStyle(pointLabelStyle);
						}

						const textStyle = pointLabelStyle.getText();
						try{
							if (textStyle) {
								textStyle.setText(document.getElementById('XCoordinate').value+"\n"+document.getElementById('YCoordinate').value);
							}
						}							
						catch{}
						console.log("STIL PRIMJENJEN1233");
						feature.setStyle(pointLabelStyle);
						console.log(feature);
						goToCoordsSource.addFeature(feature);
						map.getView().setCenter(htrsCoords);
						map.getView().setZoom(13);
									
			  			
						if (coordinatesPanelEPSG=="4326"){
							if (epsg==4326){
								transformAndWriteCoordsInPanel(x,y, coordinatesPanelEPSG);
							}
							else if (epsg=3765){
								var pointWGS84=ol.proj.transform([x,y], projection, 'EPSG:4326');
								transformAndWriteCoordsInPanel(pointWGS84[0],pointWGS84[1], coordinatesPanelEPSG);
							}
						}
						else if (coordinatesPanelEPSG=="3765"){	
							if (epsg==4326){
								var pointHTRS=ol.proj.transform([x,y], 'EPSG:4326', projection);
								transformAndWriteCoordsInPanel(pointHTRS[0],pointHTRS[1], coordinatesPanelEPSG);								
							}
							else if (epsg=3765){
								transformAndWriteCoordsInPanel(x,y, coordinatesPanelEPSG);
							}
						}
					}
					else{
						document.getElementById('gotoCoordinatesWarning').style.display='block';						
					}
				}
				else{
					document.getElementById('gotoCoordinatesWarning').style.display='block';
				}
			});

			
			/*const projection = map.getView().getProjection();
			const projectionExtent = projection.getExtent();
			const size = ol.extent.getWidth(projectionExtent) / 256;
			const resolutions = new Array(19);
			const matrixIds = new Array(19);
			for (let z = 0; z < 19; ++z) {
			  // generate resolutions and matrixIds arrays for this WMTS
			  resolutions[z] = size / Math.pow(2, z);
			  matrixIds[z] = z;
			}
			console.log(matrixIds);
			console.log(resolutions);
			
			const wmtsLayerTK25 = new ol.layer.Tile({
				source: new ol.source.WMTS({
					url: 'https://geoportal.dgu.hr/services/auth/dof_hok_tk/wmts?authKey=fee6e8df-d92b-4413-bef0-e1900c882886d&', // Your WMTS URL
					layer: 'TK25', // Layer identifier
					matrixSet: 'EPSG:900913', // Matrix set identifier
					format: 'image/jpeg',
					projection: projection,
					tileGrid: new ol.tilegrid.TileGrid({
						extent: map.getView().getProjection().getExtent(),
						resolutions: [ // Resolutions for EPSG:900913 (from your capabilities document)
        5.590822639508929E8, 2.7954113197544646E8, 1.3977056598772323E8, 6.988528299386162E7,
        3.494264149693081E7, 1.7471320748465404E7, 8735660.374232702, 4367830.187116351,
        2183915.0935581755, 1091957.5467790877, 545978.7733895439, 272989.38669477194,
        136494.69334738597, 68247.34667369298, 34123.67333684649, 17061.836668423246,
        8530.918334211623, 4265.4591671058115, 2132.7295835529058, 1066.3647917764529,
        533.1823958882264, 266.5911979441132, 133.2955989720566, 66.6477994860283,
        33.32389974301415, 16.661949871507076, 8.330974935753538, 4.165487467876769,
        2.0827437339383845, 1.0413718669691923, 0.5206859334845961
      ],
      matrixIds: [ // Matrix IDs must be strings
        "EPSG:900913:0", "EPSG:900913:1", "EPSG:900913:2", "EPSG:900913:3",
        "EPSG:900913:4", "EPSG:900913:5", "EPSG:900913:6", "EPSG:900913:7",
        "EPSG:900913:8", "EPSG:900913:9", "EPSG:900913:10", "EPSG:900913:11",
        "EPSG:900913:12", "EPSG:900913:13", "EPSG:900913:14", "EPSG:900913:15",
        "EPSG:900913:16", "EPSG:900913:17", "EPSG:900913:18", "EPSG:900913:19",
        "EPSG:900913:20", "EPSG:900913:21", "EPSG:900913:22", "EPSG:900913:23",
        "EPSG:900913:24", "EPSG:900913:25", "EPSG:900913:26", "EPSG:900913:27",
        "EPSG:900913:28", "EPSG:900913:29", "EPSG:900913:30"
      ],
					}),
					style: 'default',
				}),
			});
			
			map.addLayer(wmtsLayerTK25);*/
			
			
			let katastarLayer = new ol.layer.Image({
				source: new ol.source.ImageWMS({
					attributions: '<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>',
					url: "https://api.uredjenazemlja.hr/services/inspire/cp_wms/wms",
					params: {
						'LAYERS': 'CP.CadastralParcel',
						'STYLES': 'CP.CadastralParcel.Default',
						'CRS': 'EPSG:3765'
					},
					serverType: 'geoserver',
					crossOrigin: 'anonymous'
				}),
				maxResolution: 0.5,
			});
			
			
			
			/*let katastarLayer=new ol.layer.Tile({
					
				source: new ol.source.TileWMS({
					attributions: '<a target="_blank" href="https://dgu.gov.hr/">Državna geodetska uprava</a>; <a target="_blank" href="https://geoportal.dgu.hr/">Geoportal DGU</a>',
					
					//maxZoom:8,
					url: "https://api.uredjenazemlja.hr/services/inspire/cp_wms/wms",						
					params: {
						'LAYERS': 'CP.CadastralParcel', // Correct layer name from GetCapabilities
						'TILED': false,
						'CRS': 'EPSG:3765',
						'STYLES': 'CP.CadastralParcel.Default'
					},
					serverType: 'geoserver',
					crossOrigin:'anonymous'
				}),
				maxResolution: 0.5,
				//minZoom:13,
			});*/
			katastarLayer.setZIndex(4);
			katastarLayer.setVisible(false);
			map.addLayer(katastarLayer);
			katastarLayer.setZIndex(4);
			
			document.getElementById('katastarLayerVisibilityCheckbox').addEventListener("change", function () {				
				katastarLayer.setVisible(this.checked);
			});
			
			document.getElementById('katastarLayerVisibilitySlider').addEventListener('input', function () {
				const opacity = Number(this.value);

				if (!isNaN(opacity) && opacity >= 0 && opacity <= 1) { // Check if it's a valid number and within range.
					katastarLayer.setOpacity(opacity);
				} else {
					console.error("Invalid opacity value:", this.value); // Debugging
				}
			});
			
			// Handle basemap changes
			/*document.getElementById('basemaps').addEventListener('change', function(event) {
				const selectedUrl = event.target.value;
				map.removeLayer(basemapLayer); // Remove the existing layer
				basemapLayer = createWmsLayer(selectedUrl); // Create a new layer
				basemapLayer.setZIndex(0)
				map.addLayer(basemapLayer); // Add the new layer
			});*/
			
			/*document.getElementById('overbasemaps').addEventListener('change', function(event) {
				const selectedUrl = event.target.value;
				map.removeLayer(overbasemapLayer); // Remove the existing layer
				overbasemapLayer = createWmsLayer(selectedUrl); // Create a new layer
				overbasemapLayer.setZIndex(1)
				map.addLayer(overbasemapLayer); // Add the new layer
			});*/

			// Optional: Add a scale line
			const scaleLineControl = new ol.control.ScaleLine();
			map.addControl(scaleLineControl);

			// Optional: Add a full-screen control
			const fullScreenControl = new ol.control.FullScreen();
			map.addControl(fullScreenControl);
			
			
			
			/*document.querySelectorAll('#layer-menu button').forEach(button => {
			   button.addEventListener('click', function () {
					const selectedUrl = this.getAttribute('data-url');
					const layerName = this.innerHTML;
					console.log(layerName)
					//const attributionText = basemapAttributions[selectedUrl];

					if (layerName) {
						map.removeLayer(basemapLayer);
						basemapLayer = createWmsLayer(selectedUrl);
						map.addLayer(basemapLayer);
					}
					
					// Remove active class from all buttons
					document.querySelectorAll('#layer-menu button').forEach(btn => {
						btn.style.backgroundColor = ''; // Reset color
					});

					// Highlight the selected button
					this.style.backgroundColor = 'lightblue';

					// Sakrij meni nakon izbora sloja
					document.getElementById('layer-menu').style.display = 'none';
				});
			});*/
			
			// Set the first radio as checked by default
			const basemapSecondRadio = document.querySelectorAll('#basemapMenu input[type="radio"]')[1];
			if (basemapSecondRadio) {
				basemapSecondRadio.checked = true;
			}
			const overbasemapFirstRadio = document.querySelector('#overbasemapMenu input[type="radio"]');
			if (overbasemapFirstRadio) {
				overbasemapFirstRadio.checked = true;
			}
			
			document.querySelectorAll('#basemapMenu input[type="radio"]').forEach(radio => {
				radio.addEventListener('change', function () {
					const layerType = this.getAttribute('data-layer');
					const layerService = this.getAttribute('data-layer-service');
					if (layerType) {
						initializeAndAddBasemapLayer(layerType,layerService);
					}
				});
			});

			// Handle radio button change for overlay basemap
			document.querySelectorAll('#overbasemapMenu input[type="radio"]').forEach(radio => {
				radio.addEventListener('change', function () {
					const layerType = this.getAttribute('data-layer');
					const layerService = this.getAttribute('data-layer-service');
					if (layerType) {
						initializeAndAddOverbasemapLayer(layerType,layerService);
					}
				});
			});
				
			document.getElementById('overbasemapVisibilitySlider').addEventListener('input', function () {
				const opacity = Number(this.value);

				if (!isNaN(opacity) && opacity >= 0 && opacity <= 1) { // Check if it's a valid number and within range.
					overbasemapLayer.setOpacity(opacity);
				} else {
					console.error("Invalid opacity value:", this.value); // Debugging
				}
			});
			
			
			const swipe = document.getElementById('swipe');
			swipe.addEventListener('input', function () {
				map.render();
			});
			
			function clipLayer(event) {
				const ctx = event.context;
				const mapSize = map.getSize();
				const width = mapSize[0] * (swipe.value / 100);
				const tl = ol.render.getRenderPixel(event, [width, 0]);
				const tr = ol.render.getRenderPixel(event, [mapSize[0], 0]);
				const bl = ol.render.getRenderPixel(event, [width, mapSize[1]]);
				const br = ol.render.getRenderPixel(event, mapSize);

				ctx.save();
				ctx.beginPath();
				ctx.moveTo(tl[0], tl[1]);
				ctx.lineTo(bl[0], bl[1]);
				ctx.lineTo(br[0], br[1]);
				ctx.lineTo(tr[0], tr[1]);
				ctx.closePath();
				ctx.clip();
			}

			function restoreLayer(event) {
				event.context.restore();
			}
			
						
			
			
			
			
			
			
			
			
			const geolocation = new ol.Geolocation({
			  	// enableHighAccuracy must be set to true to have the heading value.
			  	trackingOptions: {
					enableHighAccuracy: true,
			  	},
			  	projection: view.getProjection(),
			});
			let isTrackingEnabled=false;
			document.getElementById('locationTrackingButton').addEventListener('click', function () {	
				if (isTrackingEnabled==false){
					isTrackingEnabled=true;					
					geolocation.setTracking(true);				
				}	
				else{
					isTrackingEnabled=false;
					geolocation.setTracking(false);
				}
			});
			
			geolocation.on('change', function () {
			  /*el('accuracy').innerText = geolocation.getAccuracy() + ' [m]';
			  el('altitude').innerText = geolocation.getAltitude() + ' [m]';
			  el('altitudeAccuracy').innerText = geolocation.getAltitudeAccuracy() + ' [m]';
			  el('heading').innerText = geolocation.getHeading() + ' [rad]';
			  el('speed').innerText = geolocation.getSpeed() + ' [m/s]';*/
			  //alert("AFAFQ");
			});

			// handle geolocation error.
			geolocation.on('error', function (error) {
			  /*const info = document.getElementById('info');
			  info.innerHTML = error.message;
			  info.style.display = '';*/
			  //alert("NE MOZEMO DO LOKACIJE");
			});

			const accuracyFeature = new ol.Feature();
			
			geolocation.on('change:accuracyGeometry', function () {
			  	accuracyFeature.setGeometry(geolocation.getAccuracyGeometry());
			});

			const positionFeature = new ol.Feature();
			positionFeature.setStyle(new ol.style.Style({
				image: new ol.style.Circle({
				  	radius: 6,					  	
					fill: new ol.style.Fill({
						color: '#3399CC',
					  }),
					  stroke: new ol.style.Stroke({
						color: '#fff',
						width: 2,
					  }),
				}),
			}));

			geolocation.on('change:position', function () {
			  	const coordinates = geolocation.getPosition();
			  	positionFeature.setGeometry(coordinates ? new ol.geom.Point(coordinates) : null);
			});

			new ol.layer.Vector({
			  	map: map,
			  	source: new ol.source.Vector({
					features: [accuracyFeature, positionFeature],
					crossOrigin:'anonymous'
			  	}),
			});
			
			
			
			
			


			//measure
			const measureSource = new ol.source.Vector({crossOrigin:'anonymous'});

			const measureLayer = new ol.layer.Vector({
				source: measureSource,
				style: function (feature) {
					return styleFunction(feature, document.getElementById('showSegmentLengthsCheckbox').checked);
				},
			});
			measureLayer.setZIndex(20);
			map.addLayer(measureLayer);
			measureLayer.setZIndex(20);
			
			//measureStyle sluzi za iscrtavanje featurea dok je u fazi crtanja, a i nakon sto bude gotov. to je stil mjerenja
			const measureStyle = new ol.style.Style({
				fill: new ol.style.Fill({
					color: 'rgba(255, 255, 255, 0.2)',
				}),
				stroke: new ol.style.Stroke({
					color: 'red',
					//lineDash: [10, 10],
					width: 2,
				}),
				image: new ol.style.Circle({
					radius: 5,
					stroke: new ol.style.Stroke({
						color: 'red',
					}),
					fill: new ol.style.Fill({
						color: 'rgba(255, 255, 255, 0.2)',
					}),
				}),
			});
			
			//measureLabelStyle sluzi za iscrtavanje zadnjeg tooltipa s konacnom mjerom
			const measureLabelStyle = new ol.style.Style({
				text: new ol.style.Text({
					font: '14px Calibri,sans-serif',
					fill: new ol.style.Fill({
						color: 'rgba(255, 255, 255, 1)',
					}),
					backgroundFill: new ol.style.Fill({
						color: 'rgba(0, 0, 0, 0.7)',
					}),
					padding: [3, 3, 3, 3],
					textBaseline: 'bottom',
					offsetY: -15,
				}),
				image: new ol.style.RegularShape({
					radius: 6,
					points: 3,
					angle: Math.PI,
					displacement: [0, 8],
					fill: new ol.style.Fill({
						color: 'rgba(0, 0, 0, 0.7)',
					}),
				}),
			});
			
			//measureTipStyle sluzi da ispise Klikinte za pocetak crtanja ili Kliknite za nastavak crtanja
			const measureTipStyle = new ol.style.Style({
				text: new ol.style.Text({
					font: '12px Calibri,sans-serif',
					fill: new ol.style.Fill({
						color: 'rgba(255, 255, 255, 1)',
					}),
					backgroundFill: new ol.style.Fill({
						color: 'rgba(0, 0, 0, 0.4)',
					}),
					padding: [2, 2, 2, 2],
					textAlign: 'left',
					offsetX: 15,
				}),
			});
			
			
			//measureModifyStyle sluzi za stil za modify tj. koristi se kad se priblizi nekoj grafici
			const measureModifyStyle = new ol.style.Style({
				image: new ol.style.Circle({
					radius: 5,
					stroke: new ol.style.Stroke({
						color: 'rgba(0, 0, 0, 0.7)',
					}),
					fill: new ol.style.Fill({
						color: 'rgba(0, 0, 0, 0.4)',
					}),
				}),
				text: new ol.style.Text({
					text: 'Povucite za promjenu',
					font: '12px Calibri,sans-serif',
					fill: new ol.style.Fill({
						color: 'rgba(255, 255, 255, 1)',
					}),
					backgroundFill: new ol.style.Fill({
						color: 'rgba(0, 0, 0, 0.7)',
					}),
					padding: [2, 2, 2, 2],
					textAlign: 'left',
					offsetX: 15,
				}),
			});
	
			//measureSegmentStyle sluzi za stil za medju tooltipove tj. one koji se nalaze na sredini linije
			const measureSegmentStyle = new ol.style.Style({
				text: new ol.style.Text({
					font: '12px Calibri,sans-serif',
					fill: new ol.style.Fill({
						color: 'rgba(255, 255, 255, 1)',
					}),
					backgroundFill: new ol.style.Fill({
						color: 'rgba(0, 0, 0, 0.4)',
					}),
					padding: [2, 2, 2, 2],
					textBaseline: 'bottom',
					offsetY: -12,
				}),
				image: new ol.style.RegularShape({
					radius: 6,
					points: 3,
					angle: Math.PI,
					displacement: [0, 8],
					fill: new ol.style.Fill({
						color: 'rgba(0, 0, 0, 0.6)',
					}),
				}),
			});
			
			//measurePointWithLabelStyle sluzi za stil za dodavanje tocaka
			const measurePointWithLabelStyle = new ol.style.Style({
				text: new ol.style.Text({
					font: '14px Calibri,sans-serif',
					fill: new ol.style.Fill({
						color: 'rgba(255, 255, 255, 1)',
					}),
					backgroundFill: new ol.style.Fill({
						color: 'rgba(0, 0, 0, 0.7)',
					}),
					padding: [3, 3, 3, 3],
					textBaseline: 'bottom',
					offsetY: -8,
				}),				
				image: new ol.style.Circle({
					radius: 5,
					stroke: new ol.style.Stroke({
						color: 'red',
					}),
					fill: new ol.style.Fill({
						color: 'rgba(0, 0, 0, 0.4)',
					}),
				}),			
			});


			const formatLength = function (line) {
				//ne koristiti ol.sphere jer je karta vec u 3765
				//const length = ol.sphere.getLength(line);
				const length = line.getLength();
				let output;
				if (length > 1000) {
				output = Math.round((length / 1000) * 100) / 100 + ' km';
				} else {
					output = Math.round(length * 100) / 100 + ' m';
				}
				return output;
			};

			const formatArea = function (polygon) {
				//ne koristiti ol.sphere jer je karta vec u 3765
				//const area = ol.sphere.getArea(polygon);
				const area =polygon.getArea();
				let output;
				if (area > 10000) {
					output = Math.round((area / 1000000) * 100) / 100 + ' km\xB2';
				} else {
					output = Math.round(area * 100) / 100 + ' m\xB2';
				}
				return output;
			};
			
			
			
			
			const segmentStyles = [measureSegmentStyle];
			let measureTipPoint;
			
			const measureModify = new ol.interaction.Modify({source: measureSource, style: measureModifyStyle});
			map.addInteraction(measureModify);
			let measureDraw; // global so we can remove it later
			let currentDrawType;

			function styleFunction(feature, showSegmentLengthLabel,drawType, tip) {
			
				const styles = [];
				const geometry = feature.getGeometry();
				const type = geometry.getType();
				let point, label, line;
				
				//za svaku geometriju, bila ona linija ili poligon, kreira se line. to je bitno jer se inace ne bi mogla izracunati duljina stranice poligona
				if (!drawType || drawType === type) {					
					styles.push(measureStyle);
					if (type === 'Polygon') {
						point = geometry.getInteriorPoint();
						label = formatArea(geometry);
						line = new ol.geom.LineString(geometry.getCoordinates()[0]);
					} else if (type === 'LineString') {
						point = new ol.geom.Point(geometry.getLastCoordinate());
						label = formatLength(geometry);
						line = geometry;
					}
				}

				if (showSegmentLengthLabel && line) {
					//ovaj dio funkcije iscrtava samo vrijednosti duljine segmenta na pola udaljenosti izmedju krajnjih tocaka segmenta i to samo ako je checkbox oznacen
					//zato tu mozemo maknuti provjeru za showText jer izvrsavanjem ovog koda upravlja varijabla showSegmentLengthLabel
					let count = 0;
					line.forEachSegment(function (a, b) {
						const segment = new ol.geom.LineString([a, b]);
						const label = formatLength(segment);
						if (segmentStyles.length - 1 < count) {
							segmentStyles.push(measureSegmentStyle.clone());
						}
						const segmentPoint = new ol.geom.Point(segment.getCoordinateAt(0.5));
						segmentStyles[count].setGeometry(segmentPoint);
						
						segmentStyles[count].getText().setText(label);
						
						styles.push(segmentStyles[count]);
						count++;
					});
				}
				
				if (label) {
					measureLabelStyle.setGeometry(point); // Correctly set geometry for all types					
					if (showText){
						measureLabelStyle.getText().setText(label);
					}
					else{
						measureLabelStyle.getText().setText("");
					}
					styles.push(measureLabelStyle);
				}

				if (tip && type === 'Point' && !measureModify.getOverlay().getSource().getFeatures().length) {					
					measureTipPoint = geometry;
					if (showText){
						measureTipStyle.getText().setText(tip);
					}
					//ovo aluzi samo za draw tocaka kada se pomice pointer a prije nego se doda tocka
					else{
						measureTipStyle.getText().setText("");
					}
					styles.push(measureTipStyle);
				}
				
				if (type === 'Point' && feature.get('isPoint')) {
					const coordinates = feature.getGeometry().getCoordinates();
					const lonLat=ol.proj.transform(coordinates, projection, 'EPSG:4326');
					//const lonLat = ol.proj.toLonLat(coordinates);
					const labelText = lonLat[0].toFixed(6) + "\n" + lonLat[1].toFixed(6);

					let pointLabelStyle = feature.getStyle();

					if (!pointLabelStyle) {
						pointLabelStyle = measurePointWithLabelStyle.clone();
						//feature.setStyle(pointLabelStyle);
					}

					const textStyle = pointLabelStyle.getText();
					try{
						if (textStyle) {
							textStyle.setText(labelText);
							textStyle.setGeometry(geometry);
						}
					}catch{
						console.log(geometry);						
					}

					styles.push(pointLabelStyle);
				}
				
				return styles;
			}

			function clearMeasureLayer() {
				measureSource.clear();
			}

			function addMeasureInteraction(drawType) {
				const activeTip = 'Kliknite za nastavak crtanja ';
				const idleTip = 'Kliknite za početak crtanja';
				let tip = idleTip;

				if (measureDraw) {
					map.removeInteraction(measureDraw);
				}
				currentDrawType = drawType;
				measureDraw = new ol.interaction.Draw({
					source: measureSource,
					type: drawType,
					style: function (feature) {
						return styleFunction(feature, document.getElementById('showSegmentLengthsCheckbox').checked, drawType, tip);
					},
				});

				measureDraw.on('drawstart', function () {
					measureModify.setActive(false);
					tip = activeTip;
				});

				measureDraw.on('drawend', function (event) {
					measureModifyStyle.setGeometry(measureTipPoint);
					measureModify.setActive(true);

					const feature = event.feature; // Get the feature from the event
					
					if (drawType === 'Point') {
						feature.set('isPoint', true);

						const coordinates = feature.getGeometry().getCoordinates();
						const lonLat=ol.proj.transform(coordinates, projection, 'EPSG:4326');
						//const lonLat = ol.proj.toLonLat(coordinates);
						const labelText = lonLat[0].toFixed(6) + "\n" + lonLat[1].toFixed(6);
						let pointLabelStyle = feature.getStyle();
						//console.log(pointLabelStyle);
						if (!pointLabelStyle) {
							pointLabelStyle = measurePointWithLabelStyle.clone();
							feature.setStyle(pointLabelStyle);
						}
						
						pointLabelStyle.setGeometry(feature.getGeometry());
						
						const textStyle = pointLabelStyle.getText();
						
						if (textStyle) {
							if (showText){
								textStyle.setText(labelText);		
							}							
						}
					}

					map.once('pointermove', function () {
						measureModifyStyle.setGeometry();
					});
					tip = idleTip;
				});

				measureModify.setActive(true);
				map.addInteraction(measureDraw);
			}

			measureModify.on('modifyend', function (event) {
				const feature = event.features.getArray()[0];
				if (feature.getGeometry().getType() === 'Point' && feature.get('isPoint')) {
					const coordinates = feature.getGeometry().getCoordinates();
					const lonLat=ol.proj.transform(coordinates, projection, 'EPSG:4326');
					//const lonLat = ol.proj.toLonLat(coordinates);
					const labelText = lonLat[0].toFixed(6) + "\n" + lonLat[1].toFixed(6);

					let pointLabelStyle = feature.getStyle();

					if (!pointLabelStyle) {
						pointLabelStyle = measurePointWithLabelStyle.clone();
						feature.setStyle(pointLabelStyle);
					}
					
					pointLabelStyle.setGeometry(feature.getGeometry());
					
					const textStyle = pointLabelStyle.getText();
					if (textStyle) {
						if (showText){
							textStyle.setText(labelText);		
						}
												
					}
					//console.log(coordinatesPanelEPSG);
					if (coordinatesPanelEPSG!='4326'){
						//const newCoords = ol.proj.transform([lonLat[0],lonLat[1]], 'EPSG:4326', 'EPSG:3765');	
						transformAndWriteCoordsInPanel(coordinates[0], coordinates[1], '3765');
					}
					else{
						transformAndWriteCoordsInPanel(lonLat[0], lonLat[1], '4326');
					}
					measureLayer.changed();
				}
			});
			
			
			
			let measureSelectInteraction = new ol.interaction.Select(); // Separate select interaction for measure layer
			measureSelectInteraction.on('select', function (event) {
				//console.log("IPAK IMAMO SELECT");
				const selectedFeatures = event.target.getFeatures();

				selectedFeatures.forEach(feature => {
					measureSource.removeFeature(feature); // Remove the selected feature from measureSource
				});
				selectedFeatures.clear(); // Clear selection after deletion
			});

			let measureSelectInteractionActive = null;

			function enableMeasureDeleteMode() {
				//prvo provjeravamo da nije ukljucen neki draw i ako je onda ga maknemo
				if (currentDrawType !=""){
					map.removeInteraction(measureDraw);
					currentDrawType ="";
				}
			
				if (measureSelectInteractionActive) {
					document.body.style.cursor = "default";
					map.removeInteraction(measureSelectInteraction);
					measureSelectInteractionActive = null;
					map.addInteraction(measureModify); // Re-enable modify interaction if needed
					return;
				}

				measureSelectInteractionActive = "active";
				map.removeInteraction(measureModify); // Disable modify interaction while in delete mode

				// Disable draw interaction if active (similar to your existing logic)
				/*if (measureDraw) { // Assuming measureDraw is your measure draw interaction
					map.removeInteraction(measureDraw);
					// ... any other cleanup related to measure drawing
				}*/

				map.addInteraction(measureSelectInteraction);
				//document.body.style.cursor = "no-drop";
			}
			
			
			
			let showText = true;
			function updateTextStyle(ugasi) {
				//console.log("IMAMO UGASI");
				measureSource.getFeatures().forEach(feature => {
					if (ugasi){
						if (feature.getStyle())
						{
							if (feature.getStyle().getText()){
								if (feature.getGeometry().getType()==="Point"){feature.getStyle().getText().setText("");}
							}
						}
					}
					else
					{
						if (feature.getStyle())
						{
							if (feature.getStyle().getText()){
								if (feature.getGeometry().getType()==="Point"){
									const coordinates = feature.getGeometry().getCoordinates();
									const lonLat = ol.proj.toLonLat(coordinates);
									const labelText = lonLat[0].toFixed(6) + "\n" + lonLat[1].toFixed(6);
									feature.getStyle().getText().setText(labelText);
								}
							}
						}
					}
					console.log(feature.text); // Apply the updated style
				});

				measureLayer.changed(); 
			}
			
			
			document.getElementById('showSegmentLengthsCheckbox').addEventListener("change", function () {
			  measureLayer.changed();
			  measureDraw.getOverlay().changed();
			});
			
			document.getElementById('showMeasurementsCheckbox').addEventListener("change", function () {				
				updateTextStyle(showText);
				showText = !showText;
				//measureLayer.changed(); // Essential: Force layer redraw
				//measureDraw.getOverlay().changed();
			});
			
			document.getElementById("measurePointsButton").addEventListener("click", function () {
				if (map.getInteractions().getArray().some(interaction => interaction === measureSelectInteraction)) {
					map.removeInteraction(measureSelectInteraction);
				}
				if (currentDrawType == "Point")
				{
					if (measureDraw) {
						map.removeInteraction(measureDraw);
						currentDrawType =""
					}
				}
				else
				{
					addMeasureInteraction("Point");
				}
				map.addInteraction(measureModify);
			});

			document.getElementById("measureLinesButton").addEventListener("click", function () {
				if (map.getInteractions().getArray().some(interaction => interaction === measureSelectInteraction)) {
					map.removeInteraction(measureSelectInteraction);
				}
				if (currentDrawType == "LineString")
				{
					if (measureDraw) {
						map.removeInteraction(measureDraw);
						currentDrawType =""
					}
				}
				else
				{
					addMeasureInteraction("LineString");
				}
				map.addInteraction(measureModify);
			});
			

			document.getElementById("measurePolygonsButton").addEventListener("click", function () {
				if (map.getInteractions().getArray().some(interaction => interaction === measureSelectInteraction)) {
					map.removeInteraction(measureSelectInteraction);
				}
				if (currentDrawType == "Polygon")
				{
					if (measureDraw) {
						map.removeInteraction(measureDraw);
						currentDrawType =""
					}
				}
				else
				{
					addMeasureInteraction("Polygon");
				}
				map.addInteraction(measureModify);
			});

			function enableDissableMeasureDeleteMode() {
				//prvo micemo measureDraw ako je dodan
				if (measureDraw) {
					map.removeInteraction(measureDraw);
					currentDrawType =""
				}
				if (!map.getInteractions().getArray().some(interaction => interaction === measureSelectInteraction)) {					
					map.removeInteraction(measureModify);
					map.addInteraction(measureSelectInteraction);					
					map.on('pointermove', changePointerOnTopOfFeature);
				}
				else
				{
					document.body.style.cursor = "default";
					map.removeInteraction(measureSelectInteraction);
					map.un('pointermove', changePointerOnTopOfFeature);
					map.addInteraction(measureModify); // Re-enable modify interaction
				}	
			}

			
			function changePointerOnTopOfFeature(event){
				const pixel = event.pixel;
				const features = [];

				map.forEachFeatureAtPixel(pixel, function (feature) {
					if (measureSource.getFeatures().indexOf(feature) !== -1) { // Check if feature is in measureSource
						features.push(feature);
					}
				});

				if (features.length > 0) {
					map.getViewport().style.cursor = 'no-drop'; // Change cursor to pointer
				} else {
					map.getViewport().style.cursor = ''; // Reset cursor to default
				}			
			}

			document.getElementById("measureDeleteSelectedButton").addEventListener("click", enableDissableMeasureDeleteMode);
			
			document.getElementById("measureDeleteAllButton").addEventListener("click", function () {
				if (map.getInteractions().getArray().some(interaction => interaction === measureSelectInteraction)) {
					map.removeInteraction(measureSelectInteraction);
				}
				if (map.getInteractions().getArray().some(interaction => interaction === measureDraw)) {
					map.removeInteraction(measureDraw);
					currentDrawType =""
				}
				clearMeasureLayer();
				map.addInteraction(measureModify);
			});
			
			
			document.getElementById('measureLayerVisibilityCheckbox').addEventListener("change", function () {				
				measureLayer.setVisible(this.checked);
			});
			
			document.getElementById('measureLayerVisibilitySlider').addEventListener('input', function () {
				const opacity = Number(this.value);

				if (!isNaN(opacity) && opacity >= 0 && opacity <= 1) { // Check if it's a valid number and within range.
					measureLayer.setOpacity(opacity);
				} else {
					console.error("Invalid opacity value:", this.value); // Debugging
				}
			});
			
			document.getElementById('uploadKMLButton').addEventListener('click', function () {
				const fileInput = document.createElement('input');
				fileInput.type = 'file';
				fileInput.accept = '.kml, .kmz';

				fileInput.addEventListener('change', function (event) {
					const file = event.target.files[0];
					if (file) {
						const reader = new FileReader();
						reader.onload = function (e) {
							const kmlData = e.target.result;

							const kmlFormat = new ol.format.KML({ extractStyles: true });
							const features = kmlFormat.readFeatures(kmlData);

							const transformedFeatures = [];

							features.forEach(feature => {
								const geometry = feature.getGeometry();
								if (geometry) {
									const transformedGeometry = geometry.clone().transform('EPSG:4326', map.getView().getProjection());
									feature.setGeometry(transformedGeometry);
									transformedFeatures.push(feature);
								}
							});

							const vectorSource = new ol.source.Vector({
								features: transformedFeatures,
								crossOrigin:'anonymous'
							});

							const kmlLayer = new ol.layer.Vector({
								source: vectorSource,
								style: feature => {
									return feature.getStyle() || new ol.style.Style({ /* your default style */ });
								}
							});
							kmlLayer.setZIndex(3);
							map.addLayer(kmlLayer);
							kmlLayer.setZIndex(3);

							vectorSource.once('change', () => {
								if (vectorSource.getState() === 'ready') {
									map.getView().fit(vectorSource.getExtent());
								}
							});


							/*// *** NEW: Create controls for EACH layer ***
							const controlsDiv = document.createElement('div');
							// Add OpenLayers control classes
							controlsDiv.style.pointerEvents = 'auto'; // Enable pointer events
							controlsDiv.style.position = 'relative'; // For positioning elements within

							// Create a container for the buttons (optional, but good for organization)
							const buttonContainer = document.createElement('div');
							buttonContainer.style.display = 'flex'; // Arrange buttons horizontally
							buttonContainer.style.gap='5px';
							
							// Visibility Checkbox
							const checkboxLabel = document.createElement('label');
							checkboxLabel.for = 'kml-layer-visibility-' + kmlLayer.ol_uid;
							checkboxLabel.style.display = 'flex'; // Align checkbox and text
							checkboxLabel.style.alignItems = 'center'; // Vertically center
							const checkbox = document.createElement('input');
							checkbox.type = 'checkbox';
							checkbox.id = 'kml-layer-visibility-' + kmlLayer.ol_uid;
							checkbox.checked = true;
							checkboxLabel.appendChild(checkbox);
							checkboxLabel.appendChild(document.createTextNode(file.name)); // Add file name
							buttonContainer.appendChild(checkboxLabel); // Add to button container


							// Opacity Slider
							const slider = document.createElement('input');
							slider.type = 'range';
							slider.id = 'kml-layer-opacity-' + kmlLayer.ol_uid;
							slider.min = '0';
							slider.max = '1';
							slider.step = '0.1';
							slider.value = '1';
							slider.style.minWidth = '80px'; // Set a width for the slider
							buttonContainer.appendChild(slider); // Add to button container

							// Zoom to Extent Button
							const zoomToExtentDiv = document.createElement('div');
							zoomToExtentDiv.style.pointerEvents = 'auto'; // Enable pointer events
							zoomToExtentDiv.style.position = 'relative';
							zoomToExtentDiv.className = 'ol-control ol-unselectable';
							
							const zoomToExtentButton = document.createElement('button');							
							zoomToExtentButton.style.padding = '2px';
							zoomToExtentButton.style.width = '1.5em';
							zoomToExtentButton.style.height = '1.5em';
							zoomToExtentButton.style.background = 'white';
							zoomToExtentButton.style.display = 'flex';
							zoomToExtentButton.style.alignItems = 'center';
							zoomToExtentButton.style.justifyContent = 'center';
							zoomToExtentButton.innerHTML = '<img src="icons/arrows-to-circle-solid.svg" alt="Zoom to Extent" width="15px" height="15px">'; // Adjusted image size
							zoomToExtentButton.addEventListener('click', () => {
								map.getView().fit(kmlLayer.getSource().getExtent());
							});
							zoomToExtentDiv.appendChild(zoomToExtentButton);
							buttonContainer.appendChild(zoomToExtentDiv); // Add to button container

							// Delete Button
							const deleteDiv = document.createElement('div');
							deleteDiv.style.pointerEvents = 'auto'; // Enable pointer events
							deleteDiv.style.position = 'relative';
							deleteDiv.className = 'ol-control ol-unselectable';
							
							const deleteButton = document.createElement('button');
							deleteButton.style.padding = '2px';
							deleteButton.style.width = '1.5em';
							deleteButton.style.height = '1.5em';
							deleteButton.style.background = 'white';
							deleteButton.style.display = 'flex';
							deleteButton.style.alignItems = 'center';
							deleteButton.style.justifyContent = 'center';
							deleteButton.innerHTML = '<img src="icons/xmark-solid.svg" alt="Delete KML" width="15" height="15">'; // Adjusted image size
							deleteButton.addEventListener('click', () => {
								map.removeLayer(kmlLayer);
								controlsDiv.remove(); // Remove controls for this layer
							});
							deleteDiv.appendChild(deleteButton);
							buttonContainer.appendChild(deleteDiv); // Add to button container

							controlsDiv.appendChild(buttonContainer); // Add buttons to the controls div
							document.getElementById('layersPanel').appendChild(controlsDiv); // Add controls to the panel*/
							
							
							let zoomText="Zumiraj na sloj";
							let removeText="Makni sloj";
							if (currentLanguage == "en"){
								zoomText="Zoom to layer";
								removeText="Remove layer";
							}
							
							
							
							
							
							// *** NEW: Create controls for EACH layer ***
							const controlsDiv = document.createElement('div');
							// Add OpenLayers control classes
							controlsDiv.style.pointerEvents = 'auto'; // Enable pointer events
							controlsDiv.style.position = 'relative'; // For positioning elements within
							controlsDiv.style.padding='2px';

							// Create a container for the buttons (optional, but good for organization)
							const buttonContainer = document.createElement('div');
							buttonContainer.style.display = 'flex'; // Arrange buttons horizontally
							buttonContainer.style.gap = '5px';
							buttonContainer.style.alignItems = 'center'; // Vertically center the items

							// Visibility Checkbox
							const checkboxContainer = document.createElement('div');
							checkboxContainer.style.display = 'flex'; // Align checkbox and text in a row
							checkboxContainer.style.alignItems = 'center'; // Vertically center the checkbox and text

							// Create the checkbox
							const checkbox = document.createElement('input');
							checkbox.type = 'checkbox';
							checkbox.id = 'uploadedKmlLayerVisibility' + kmlLayer.ol_uid;
							checkbox.checked = true;

							// Append the checkbox to the container
							checkboxContainer.appendChild(checkbox);

							// Create the label
							const checkboxLabel = document.createElement('label');
							checkboxLabel.setAttribute('for', checkbox.id); // Associate label with checkbox
							checkboxLabel.style.display = 'block'; // Change to block to allow wrapping
							checkboxLabel.style.maxWidth = '180px'; // Set the maximum width for the label
							checkboxLabel.style.whiteSpace = 'normal'; // Allow wrapping
							checkboxLabel.style.overflowWrap = 'break-word'; // Break words as needed
							checkboxLabel.style.wordWrap = 'break-word'; // Old browsers support
							checkboxLabel.style.marginLeft='5px';
							checkboxLabel.style.fontWeight = 'bold';
							checkboxLabel.appendChild(document.createTextNode(file.name)); // Add file name

							// Append the label to the container
							checkboxContainer.appendChild(checkboxLabel);

							// Add the container to the button container
							buttonContainer.appendChild(checkboxContainer);

							// Opacity Slider
							const slider = document.createElement('input');
							slider.type = 'range';
							slider.id = 'uploadedKmlLayerOpacity' + kmlLayer.ol_uid;
							slider.min = '0';
							slider.max = '1';
							slider.step = '0.1';
							slider.value = '1';
							slider.style.minWidth = '80px'; // Set a width for the slider
							slider.style.marginLeft='auto';
							buttonContainer.appendChild(slider); // Add to button container

							// Zoom to Extent Button
							const zoomToExtentDiv = document.createElement('div');							
							zoomToExtentDiv.style.pointerEvents = 'auto'; // Enable pointer events
							zoomToExtentDiv.style.position = 'relative';
							zoomToExtentDiv.className = 'ol-control ol-unselectable';

							const zoomToExtentButton = document.createElement('button');
							zoomToExtentButton.setAttribute('title',zoomText);
							zoomToExtentButton.setAttribute('alt',zoomText);
							zoomToExtentButton.id = 'uploadedKmlLayerZoomToLayer' + kmlLayer.ol_uid;
							zoomToExtentButton.style.padding = '2px';
							zoomToExtentButton.style.width = '1.5em';
							zoomToExtentButton.style.height = '1.5em';
							zoomToExtentButton.style.background = 'white';
							zoomToExtentButton.style.display = 'flex';
							zoomToExtentButton.style.alignItems = 'center';
							zoomToExtentButton.style.justifyContent = 'center';
							zoomToExtentButton.innerHTML = '<img src="icons/arrows-to-circle-solid.svg" alt="Zoom to Extent" width="15px" height="15px">'; // Adjusted image size
							zoomToExtentButton.addEventListener('click', () => {
								zoomToLayerExtentOrFeature(kmlLayer);
							});
							zoomToExtentDiv.appendChild(zoomToExtentButton);
							buttonContainer.appendChild(zoomToExtentDiv); // Add to button container

							// Delete Button
							const deleteDiv = document.createElement('div');
							deleteDiv.style.pointerEvents = 'auto'; // Enable pointer events
							deleteDiv.style.position = 'relative';
							deleteDiv.className = 'ol-control ol-unselectable';

							const deleteButton = document.createElement('button');
							deleteButton.setAttribute('title',removeText);
							deleteButton.setAttribute('alt',removeText);
							deleteButton.id = 'uploadedKmlLayerRemoveLayer' + kmlLayer.ol_uid;
							deleteButton.style.padding = '2px';
							deleteButton.style.width = '1.5em';
							deleteButton.style.height = '1.5em';
							deleteButton.style.background = 'white';
							deleteButton.style.display = 'flex';
							deleteButton.style.alignItems = 'center';
							deleteButton.style.justifyContent = 'center';
							deleteButton.innerHTML = '<img src="icons/xmark-solid.svg" alt="Delete KML" width="15" height="15">'; // Adjusted image size
							deleteButton.addEventListener('click', () => {
								map.removeLayer(kmlLayer);
								controlsDiv.remove(); // Remove controls for this layer
							});
							deleteDiv.appendChild(deleteButton);
							buttonContainer.appendChild(deleteDiv); // Add to button container

							controlsDiv.appendChild(buttonContainer); // Add buttons to the controls div
							document.getElementById('layersPanel').appendChild(controlsDiv); // Add controls to the panel

							
							
							
							
							
							
							
							
							
							
							


							// *** NEW: Event listeners for EACH layer ***
							checkbox.addEventListener('change', () => {
								kmlLayer.setVisible(checkbox.checked);
							});

							slider.addEventListener('input', () => {
								const opacity = parseFloat(slider.value);
								if (!isNaN(opacity)) {
									kmlLayer.setOpacity(opacity);
								}
							});

						};
						reader.readAsText(file);
					}
				});

				fileInput.click(); // Open file dialog
			});
			
			
			document.getElementById('fullExtentButton').addEventListener('click', function () {
				/*console.log(map.getView().getProjection().getCode());
				const view= new ol.View({
					projection:'EPSG:3857',
					center: ol.proj.fromLonLat([16.40964, 43.50973]), // Centered near Croatia
					minZoom: 12,
					zoom: 15,
				});
				map.setView(view);*/
				map.getView().fit(initialExtent);				
			});
			
			
			let coordinatesPanelEPSG="4326";
			
			document.getElementById('changeCrsImg').addEventListener('click', function () {
				let coordsText = document.getElementById('pointerCoordinatesLink').innerHTML;
				coordsText = coordsText.replace('WGS84:', '').replace('HTRS96TM:','').trim();
				// Split into coordinates
				const coordsArray = coordsText.split(',');
				//console.log(ol.proj.get('EPSG:3765'));
				//console.log(typeof(coordsArray[0]));
				//console.log(coordsArray[0]+"    "+coordsArray[1]);
				if (coordsArray.length === 2) {
					const x = parseFloat(coordsArray[0]);
					const y = parseFloat(coordsArray[1].trim());
					//console.log(x+"   "+y);
					let transformedCoords;
					if (coordinatesPanelEPSG=="4326"){					
						const newCoords = ol.proj.transform([x,y], 'EPSG:4326', ol.proj.get('EPSG:3765'));					
						coordinatesPanelEPSG="3765";
						transformAndWriteCoordsInPanel(newCoords[0], newCoords[1], coordinatesPanelEPSG);
						//writeCoordsInPanel(newCoords[0], newCoords[1], coordinatesPanelEPSG);
					}
					else if (coordinatesPanelEPSG=="3765"){
						const newCoords = ol.proj.transform([x,y], 'EPSG:3765', 'EPSG:4326');	
						coordinatesPanelEPSG="4326";						
						transformAndWriteCoordsInPanel(newCoords[0], newCoords[1], coordinatesPanelEPSG);
						//writeCoordsInPanel(newCoords[0], newCoords[1], coordinatesPanelEPSG);
					}	
					else{}
				}
				else{
					if (coordinatesPanelEPSG=="4326"){					
						document.getElementById('pointerCoordinatesLink').innerHTML="HTRS96TM:";					
						coordinatesPanelEPSG="3765";						
					}
					else if (coordinatesPanelEPSG=="3765"){
						document.getElementById('pointerCoordinatesLink').innerHTML="WGS84:";		
						coordinatesPanelEPSG="4326";		
					}	
				}
				
				
			});			
			
			
			function writeCoordsInPanel(x, y, crs) {
				let sourceProj, destProj;

				if (crs === '4326') { // Input is 4326 (lon/lat), convert to 3765
					document.getElementById("pointerCoordinatesLink").innerHTML= "WGS84: "+x.toFixed(6)+", "+y.toFixed(6);
				}
				else if (crs === '3765') {
					document.getElementById("pointerCoordinatesLink").innerHTML= "HTRS96TM: "+x.toFixed(2)+", "+y.toFixed(2);
				}
			}
			
			function transformAndWriteCoordsInPanel(x, y, crs) {
				if (crs === '4326') { // Input is 4326 (lon/lat), convert to 3765
					document.getElementById("pointerCoordinatesLink").innerHTML= "WGS84: "+x.toFixed(6)+", "+y.toFixed(6);
					document.getElementById("pointerCoordinatesLink").href="http://maps.google.com/maps?q="+y.toFixed(6)+","+x.toFixed(6);
				}
				else if (crs === '3765') {
					const newCoords = ol.proj.transform([x,y], 'EPSG:3765', 'EPSG:4326');
					document.getElementById("pointerCoordinatesLink").innerHTML= "HTRS96TM: "+x.toFixed(2)+", "+y.toFixed(2);
					document.getElementById("pointerCoordinatesLink").href="http://maps.google.com/maps?q="+newCoords[1].toFixed(6)+","+newCoords[0].toFixed(6);
				}
			}

			
			map.on('click', function(event) {
				var point = map.getCoordinateFromPixel(event.pixel);				
			  	var pointWGS84=ol.proj.transform(point, projection, 'EPSG:4326');
				if (coordinatesPanelEPSG=="4326"){
					transformAndWriteCoordsInPanel(pointWGS84[0],pointWGS84[1], coordinatesPanelEPSG);
					//writeCoordsInPanel(newCoords[0], newCoords[1], coordinatesPanelEPSG);
				}
				else if (coordinatesPanelEPSG=="3765"){					
					transformAndWriteCoordsInPanel(point[0], point[1], coordinatesPanelEPSG);
					//writeCoordsInPanel(newCoords[0], newCoords[1], coordinatesPanelEPSG);
				}
			});
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			function exportFeaturesToKML(vectorLayer, filename = 'Marjan_Geoportal.kml') {
				//console.log("Exporting KML..."); // Confirmation message
				/*const now = new Date();
				const year = now.getFullYear();
				const month = String(now.getMonth() + 1).padStart(2, '0'); // Ensure two-digit month
				const day = String(now.getDate()).padStart(2, '0'); // Ensure two-digit day
				const hour = String(now.getHours()).padStart(2, '0'); // Ensure two-digit hour
				const minute = String(now.getMinutes()).padStart(2, '0'); // Ensure two-digit minute
				const second = String(now.getSeconds()).padStart(2, '0'); // Ensure two-digit second
				
				// Construct filename: Marjan_Geoportal_YYYY_MM_DD_HH_MM_SS.kml
				filename = `Marjan_Geoportal_${year}_${month}_${day}_${hour}_${minute}_${second}.kml`;*/

				const features = vectorLayer.getSource().getFeatures();
				//console.log("Number of features:", features.length); // Check number of features

				if (features.length === 0) {
					console.warn("No features to export.");
					return;
				}

				const kmlFormat = new ol.format.KML({
				
					extractStyles:true,
					writeStyles: true
				});

				const getKMLStyle = (feature) => {
					let olStyle = feature.getStyle();

					if (!olStyle) {
						olStyle = measureStyle;
					}

					if (olStyle) {
						console.log("Feature with style:", feature); // Check if getKMLStyle is called

						const kmlStyle = {};

						const fill = olStyle.getFill();
						if (fill) {
							kmlStyle.fill = rgbToHex(fill.getColor());
						}

						const stroke = olStyle.getStroke();
						if (stroke) {
							kmlStyle.stroke = rgbToHex(stroke.getColor());
							kmlStyle.width = stroke.getWidth();
						}

						const image = olStyle.getImage();
						if (image && image instanceof ol.style.Circle) {
							kmlStyle.radius = image.getRadius();
							const circleFill = image.getFill();
							if (circleFill) {
								kmlStyle.fill = rgbToHex(circleFill.getColor());
							}
							const circleStroke = image.getStroke();
							if (circleStroke) {
								kmlStyle.stroke = rgbToHex(circleStroke.getColor());
								kmlStyle.width = circleStroke.getWidth();
							}
						}

						if (image && image instanceof ol.style.Icon) {
							kmlStyle.icon = image.getSrc();
						}

						const text = olStyle.getText();
						if (text) {
							kmlStyle.text = text.getText();
							const textFill = text.getFill();
							if (textFill) {
								kmlStyle.textColor = rgbToHex(textFill.getColor());
							}
						}

						//console.log("KML Style:", kmlStyle); // Log the converted style
						return kmlStyle;
					}

					return null;
				};

				function rgbToHex(color) {
					if (!color) return null;

					if (typeof color === 'string' && color.startsWith('rgb')) {
						const parts = color.substring(color.indexOf('(') + 1, color.lastIndexOf(')')).split(',');
						const r = parseInt(parts[0].trim());
						const g = parseInt(parts[1].trim());
						const b = parseInt(parts[2].trim());
						return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
					} else if (typeof color === 'string') {
						return color;
					}
					return null;
				}



				try {  // Add a try-catch block
					const kmlFormat = new ol.format.KML({
						defaultStyle:measureStyle,
						writeStyles: true
					});
					const originalFeatures = vectorLayer.getSource().getFeatures();
					console.log(originalFeatures);
					if (originalFeatures) { // Check if features exist
						const features = [];

						originalFeatures.forEach(feature => {
							let klon=feature.clone()
							klon.setStyle(measureStyle);
							features.push(klon);
						});

						const kml = kmlFormat.writeFeatures(features, { featureProjection: map.getView().getProjection() });
						
						const kmlBlob = new Blob([kml], { type: 'application/vnd.google-earth.kml+xml' });
						const kmlUrl = URL.createObjectURL(kmlBlob);

						const link = document.createElement('a');
						link.href = kmlUrl;
						link.download = filename;
						link.style.display = 'none';
						document.body.appendChild(link);
						link.click();
						document.body.removeChild(link);
						URL.revokeObjectURL(kmlUrl);
							// ... (rest of your KML export code)
						} else {
							console.warn("No features to export.");
						}
					/*features.forEach(feature => {
						feature.setStyle(measureStyle);
						//getKMLStyle(feature));
					});
					const kml = kmlFormat.writeFeatures(features, { featureProjection: map.getView().getProjection()       });

					console.log("Generated KML:", kml); // Log the KML string*/

					

				} catch (error) {
					console.error("Error during KML export:", error); // Log any errors
				}
			}


			// Example usage:  Call this function when you want to export.
			// For example, attach it to a button's click event:
			const exportButton = document.getElementById('measureDownloadKMLButton'); // Replace with your button's ID
			exportButton.addEventListener('click', () => {
				exportFeaturesToKML(measureLayer); // Pass your vector layer
			});

			const uploadKMLToMeasureLayerButton = document.getElementById('measureUploadKMLButton'); // Replace with your button's ID
			uploadKMLToMeasureLayerButton.addEventListener('click', () => {
				const fileInput = document.createElement('input');
				fileInput.type = 'file';
				fileInput.accept = '.kml, .kmz';

				fileInput.addEventListener('change', function (event) {
					const file = event.target.files[0];
					if (file) {
						try{
							const reader = new FileReader();
							reader.onload = function (e) {
								const kmlData = e.target.result;
	
								const kmlFormat = new ol.format.KML({ extractStyles: false });
								const features = kmlFormat.readFeatures(kmlData);
	
								const transformedFeatures = [];
	
								features.forEach(feature => {
									const geometry = feature.getGeometry();
									if (geometry) {
										const transformedGeometry = geometry.clone().transform('EPSG:4326', map.getView().getProjection());
										feature.setGeometry(transformedGeometry);
										transformedFeatures.push(feature);
										console.log(feature.getGeometry());
									}
								});
	
								measureSource.addFeatures(transformedFeatures);
								measureLayer.changed();
							};
							reader.readAsText(file);
						}
						catch{}
					}
				});

				fileInput.click(); // Open file dialog
			});







			
			
			
			
			
			
			/*async function getToken(username, password) {
			  const soapRequest = '<?xml version="1.0" encoding="UTF-8"?>'+
			'<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:aut="http://oss.authentication.hr">'+
			 ' <soapenv:Header/>'+
			 ' <soapenv:Body>'+
				'<aut:authenticationRequest>'+
				  '<aut:username>wspsmarjan</aut:username>'+
				  '<aut:password>SLT5432G</aut:password>'+
				'</aut:authenticationRequest>'+
			  '</soapenv:Body>'+
			'</soapenv:Envelope>';

			  try {
				const response = await fetch('https://oss.uredjenazemlja.hr/OssWebServices/services/', {
				  method: 'POST',
				  headers: {
					'Content-Type': 'text/xml;charset=UTF-8', // Important for SOAP
					'SOAPAction': '', // Often empty, but check the WSDL if needed.
				  },
				  body: soapRequest,
				});

				if (!response.ok) {
				  const errorText = await response.text(); // Get error details from the server
				  throw new Error(`SOAP request failed with status ${response.status}: ${errorText}`);
				}

				const xmlText = await response.text();
				// Parse the XML response (using DOMParser or a library)
				const parser = new DOMParser();
				const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

				const authTokenElement = xmlDoc.querySelector('authToken'); // Use querySelector
				if (authTokenElement) {
				  const token = authTokenElement.textContent;
				  return token;
				} else {
				  console.error("authToken element not found in the response.");
				  console.log(xmlText); // Log the full XML for debugging
				  return null;
				}
			  } catch (error) {
				console.error('Error fetching token:', error);
				return null;
			  }
			}



			// Example usage:
			async function authenticate() {
			  const username = 'your_username'; // Replace with your username
			  const password = 'your_password'; // Replace with your password

			  const token = await getToken(username, password);

			  if (token) {
				console.log('Token:', token);
				// Store the token (e.g., in localStorage or a variable)
				localStorage.setItem('authToken', token);
			  } else {
				console.log('Authentication failed.');
			  }
			}

			authenticate(); // Call the async function to start authentication*/

			function changeDivEnabled(div, enabled){
				try{
					const myDiv=document.getElementById(div);
					if (enabled){
						myDiv.disabled = false;
						myDiv.style.pointerEvents = "auto";
						myDiv.style.opacity = "1";						
					}
					else{
						myDiv.disabled = true; // For form elements (input, button, select, etc.)
						myDiv.style.pointerEvents = "none"; // Prevent clicks
						myDiv.style.opacity = "0.5"; // Make it appear visually disabled (greyed out)
					}
				}catch{}				
			}
			
			
			changeDivEnabled('katastarLayerControls', false);
			map.getView().on('change:resolution', function() {				
				if (map.getView().getResolution()<katastarLayer.getMaxResolution()){					
					changeDivEnabled('katastarLayerControls', true);
				}else{
					changeDivEnabled('katastarLayerControls', false);
				}
			});
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			const rectangleSource = new ol.source.Vector({crossOrigin:'anonymous'});
			const rectangleLayer = new ol.layer.Vector({ source: rectangleSource });
			rectangleLayer.setZIndex(10000);
			map.addLayer(rectangleLayer);			
			rectangleLayer.setVisible(false);
			const translate = new ol.interaction.Translate({layers:[rectangleLayer]});
			map.addInteraction(translate);
			
			let wcsLayerToDownload='Orto_jug_2cm_2024';
			
			/*const rectangleModify = new ol.interaction.Modify({
				source: rectangleSource,
				condition: function(event) {
					return false; // Disables vertex modification
				}
			});
			map.addInteraction(rectangleModify);*/
			
			
			document.querySelectorAll('#downloadImageDataMenu input[type="radio"]').forEach(radio => {
				radio.addEventListener('change', function () {
					wcsLayerToDownload = this.getAttribute('data-layer');
					console.log('Selected Layer:', wcsLayerToDownload);
				});
			});
			document.getElementById('downloadImageDataButton').addEventListener('click', function () {
				downloadWCSData();			
			});
			
			function downloadWCSData(){								
				const features = rectangleSource.getFeatures();
				if (features.length > 0) {
					// Get the first feature (assuming only one rectangle)
					const rectangleFeature = features[0];
					// Get the extent from the geometry
					const extent = rectangleFeature.getGeometry().getExtent();
					let coverageID;
					let width;
					let height;
					let filename;
					//console.log(wcsLayerToDownload);
					changeDivEnabled('downloadImageDataButton', false);
					document.getElementById('downloadImageDataWarning').style.display='block';
					if (wcsLayerToDownload=='Marjan_hillshade_2024_50cm'){
						coverageID="MarjanOrtofoto2024:Marjan_2024_DSM_50cm_hillshade_combined";
						width=100;
						height=100;
						filename="Marjan_Sjencani_DSM_2024"
						downloadWMSImageAndJGW(marjanGisServerUrl+'geoserver/MarjanOrtofoto2024/wms', coverageID, extent, height, width, filename);
					}
					else if (wcsLayerToDownload=='Marjan_DSM_2024_50cm'){
						coverageID="MarjanOrtofoto2024:Marjan_2024_DSM_50cm";
						width=100;
						height=100;
						filename="Marjan_DSM_2024"
						downloadWMSImageAndJGW(marjanGisServerUrl+'geoserver/MarjanOrtofoto2024/wms', coverageID, extent, height, width, filename);
					}
					else if (wcsLayerToDownload=='Marjan_orto_2024_5cm'){
						//coverageID="MarjanOrtofoto2024_WCS:Marjan_jug_ortofoto";
						coverageID="MarjanOrtofoto2024:Marjan_2024_ortofoto_5cm";
						width=1000;
						height=1000;
						filename="Marjan_Ortofoto_2024"
						//downloadWMSImageAndJGW(marjanGisServerUrl+'geoserver/MarjanOrtofoto2024_WCS/wms', coverageID, extent, height, width, filename);
						downloadWMSImageAndJGW(marjanGisServerUrl+'geoserver/MarjanOrtofoto2024/wms', coverageID, extent, height, width, filename);
					}
					else if (wcsLayerToDownload=='Marjan_hillshade_2025_1_50cm'){
						coverageID="MarjanOrtofoto2025:Marjan_2025_1_DSM_50cm_hillshade_combined";
						width=100;
						height=100;
						filename="Marjan_Sjencani_DSM_2025"
						downloadWMSImageAndJGW(marjanGisServerUrl+'geoserver/MarjanOrtofoto2025/wms', coverageID, extent, height, width, filename);
					}
					else if (wcsLayerToDownload=='Marjan_DSM_2025_1_50cm'){
						coverageID="MarjanOrtofoto2025:Marjan_2025_1_DSM_50cm";
						width=100;
						height=100;
						filename="Marjan_DSM_2025"
						downloadWMSImageAndJGW(marjanGisServerUrl+'geoserver/MarjanOrtofoto2025/wms', coverageID, extent, height, width, filename);
					}
					else if (wcsLayerToDownload=='Marjan_orto_2025_1_5cm'){
						coverageID="MarjanOrtofoto2025:Marjan_2025_1_ortofoto_5cm";
						width=1000;
						height=1000;
						filename="Marjan_Ortofoto_2025"
						downloadWMSImageAndJGW(marjanGisServerUrl+'geoserver/MarjanOrtofoto2025/wms', coverageID, extent, height, width, filename);
					}
					
					
					
					/*if(coverageID){
						changeDivEnabled('downloadImageDataButton', false);
						document.getElementById('downloadImageDataWarning').style.display='block';
						//let wcsurl=buildWCSRequest(coverageID, extent, 'image/png');
						let wcsurl=buildWCSRequest(coverageID, extent, width, height, "GeoTIFF")
						fetch(wcsurl)
							.then(response => {
								if (!response.ok) {
									throw new Error('Network response was not ok');
								}
								return response.blob(); // Get the response as a Blob
								changeDivEnabled('downloadImageDataButton', true);
								document.getElementById('downloadImageDataWarning').style.display='none';
							})
							.then(blob => {
								// Create a URL for the Blob and download it
								const url = URL.createObjectURL(blob);
								const a = document.createElement('a');
								a.href = url;
								a.download = 'Marjan_Geoportal_pruzeti_podaci.tiff'; // Set the desired file name
								document.body.appendChild(a);
								a.click();
								a.remove(); // Remove the link after downloading
								URL.revokeObjectURL(url); // Free up memory
								changeDivEnabled('downloadImageDataButton', true);
								document.getElementById('downloadImageDataWarning').style.display='none';
							})
							.catch(error => {
								console.error('There was a problem with the fetch operation:', error);
							});
					}*/
				}
				else
				{
					changeDivEnabled('downloadImageDataButton', true);
					document.getElementById('downloadImageDataWarning').style.display='none';
				}
			}
			
			function buildWCSRequest(coverageId, bbox, width, height, format) {
				const wcsServer = marjanGisServerUrl+'geoserver/ows'; // Replace with your WCS server URL
				const version = '1.0.0'; // Specify the WCS version
				const request = `GetCoverage`;

				const url = `${wcsServer}?service=WCS&version=${version}&request=${request}` +
							`&COVERAGE=${coverageId}&BBOX=${bbox.join(',')}&CRS=EPSG:3765&RESPONSE_CRS=EPSG:3765` + // Assuming bbox is an array [minX, minY, maxX, maxY]
							`&FORMAT=GeoTIFF&WIDTH=${width}&HEIGHT=${height}`;
				
				return url;
			}
			
			
			/*function buildWCSRequest(coverageId, bbox, format) {
				const wcsServer = 'http://192.168.33.86:8080/geoserver/wcs'; // Replace with your WCS server URL
				const version = '1.1.1'; // Specify the WCS version
				const request = `GetCoverage`;

				const url = `${wcsServer}?service=WCS&version=${version}&request=${request}` +
							`&IDENTIFIER=${coverageId}&BOUNDINGBOX=${bbox.join(',')},urn:ogc:def:crs:EPSG::3765` + // Assuming bbox is an array [minX, minY, maxX, maxY]
							`&FORMAT=image/geotiff&` +
							`STORE=true&` +
							`GridBaseCRS=urn:ogc:def:crs:EPSG::3765&` +
							`GridType=urn:ogc:def:method:WCS:1.1:2dSimpleGrid&` +
							`GridOffsets=2.0005693657220185,-2.0018339622633987&` +
							`GridCS=urn:ogc:def:cs:OGC:0.0:Grid2dSquareCS`;

				return url;
			}*/
			
			
			async function downloadWMSImageAndJGW(wmsUrl, layerName, extent, width, height,filename) {
				const bbox = extent.join(',');
				//const width = 1000, height = 1000; // Adjust size as needed
				const wmsImageUrl = `${wmsUrl}?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap` +
					`&LAYERS=${layerName}&FORMAT=image/jpeg&SRS=EPSG:3765&BBOX=${bbox}&WIDTH=${width}&HEIGHT=${height}`;
				/*console.log(wmsImageUrl);
				fetch(wmsImageUrl)
					.then(response => response.blob())
					.then(blob => {
						const link = document.createElement('a');
						link.href = URL.createObjectURL(blob);
						link.download = 'wms_image.jpg';
						document.body.appendChild(link);
						link.click();
						document.body.removeChild(link);
						generateJGW(extent, width, height);
					})
					.catch(error => console.error('Download error:', error));*/
				try {
					const jgwContent = generateJGW(extent, width, height);
					// Fetch the WMS image
					const response = await fetch(wmsImageUrl );
					const imageBlob = await response.blob();
					
					// Trigger JPG download
					downloadFile(imageBlob, filename+".jpg");
					downloadFile(jgwContent, filename+".jgw");
					// Generate and trigger JGW download					
				} catch (error) {
					console.error("Error downloading WMS image:", error);
				}	
				changeDivEnabled('downloadImageDataButton', true);
				document.getElementById('downloadImageDataWarning').style.display='none';				
			}
			
			
			function generateJGW(bbox, width, height) {
				const [Xmin, Ymin, Xmax, Ymax] = bbox;

				// Calculate pixel resolution
				const pixelSizeX = (Xmax - Xmin) / width;
				const pixelSizeY = (Ymin - Ymax) / height; // Negative for north-up

				// JGW content format
				const jgwContent = [
					pixelSizeX.toFixed(10),
					"0.0000000000", // Rotation X
					"0.0000000000", // Rotation Y
					pixelSizeY.toFixed(10), // Negative if north-up
					Xmin.toFixed(10),
					Ymax.toFixed(10)
				].join("\n");

				// Create a Blob and trigger download
				return new Blob([jgwContent], { type: "text/plain" });
			}
			
			function downloadFile(blob, fileName) {
				const url = URL.createObjectURL(blob);
				const link = document.createElement("a");
				link.href = url;
				link.download = fileName;
				document.body.appendChild(link);
				link.click();
				document.body.removeChild(link);
				URL.revokeObjectURL(url);
			}

			
			
			
			
			
			
			
			
			
			document.getElementById('printMapButton').addEventListener('click', function () {
				map.once('rendercomplete', function () {
					var mapCanvas = document.createElement('canvas');
					var size = map.getSize();
					mapCanvas.width = size[0];
					mapCanvas.height = size[1];
					var mapContext = mapCanvas.getContext('2d');
					Array.prototype.forEach.call(
					document.querySelectorAll('.ol-layer canvas'),
					function (canvas) {
						try{
							console.log(canvas);
							if (canvas.width > 0) {
						
								var opacity = canvas.parentNode.style.opacity;
								mapContext.globalAlpha = opacity === '' ? 1 : Number(opacity);
								var transform = canvas.style.transform;
								// Get the transform parameters from the style's transform matrix
								var matrix = transform
								.match(/^matrix\(([^\(]*)\)$/)[1]
								.split(',')
								.map(Number);
								// Apply the transform to the export map context
								CanvasRenderingContext2D.prototype.setTransform.apply(
									mapContext,
									matrix
								);
								mapContext.drawImage(canvas, 0, 0);
							}
						}
						catch{}
					});
					if (navigator.msSaveBlob) {
						// link download attribuute does not work on MS browsers
						var imgName = prompt("Upišite ime karte", "survey_map");
						navigator.msSaveBlob(mapCanvas.msToBlob(), imgName + '.png');
					} else {
						var link = document.getElementById('printscreenDownload');
						link.href = mapCanvas.toDataURL();
						link.click();
					}
				});
				map.renderSync();
			});






			let currentLanguage = "hr";
			document.getElementById('changeLanguageButton').addEventListener('click', function () {
				if (currentLanguage== "hr"){
					loadTranslations("en");
					currentLanguage="en";
					this.innerHTML="HR";
					document.querySelectorAll('[id^="uploadedKmlLayerRemoveLayer"]').forEach(button => {
						button.setAttribute('title','Remove layer');
						button.setAttribute('alt','Remove layer');
					});
					document.querySelectorAll('[id^="uploadedKmlLayerZoomToLayer"]').forEach(button => {
						button.setAttribute('title','Zoom to layer');
						button.setAttribute('alt','Zoom to layer');
					});					
					document.querySelector('.ol-zoom-in').setAttribute('title','Zoom In');;
					document.querySelector('.ol-zoom-out').setAttribute('title','Zoom out');;
					try{
						document.querySelector('.ol-full-screen').setAttribute('title','Toggle full-screen');
					}catch{}
					try{
						document.querySelector('.ol-full-screen-true').setAttribute('title','Toggle full-screen');
					}catch{}
					try{
						document.querySelector('.ol-full-screen-false').setAttribute('title','Toggle full-screen');
					}catch{}
					document.getElementById('helpButtonLink').href='Marjan_Geoportal_User_Manual.pdf';
				}			
				else
				{
					loadTranslations("hr");
					currentLanguage="hr";
					this.innerHTML="EN";	
					document.querySelectorAll('[id^="uploadedKmlLayerRemoveLayer"]').forEach(button => {
						button.setAttribute('title','Makni sloj');
						button.setAttribute('alt','Makni sloj');
					});
					document.querySelectorAll('[id^="uploadedKmlLayerZoomToLayer"]').forEach(button => {
						button.setAttribute('title','Zumiraj na sloj');
						button.setAttribute('alt','Zumiraj na sloj');
					});
					document.querySelector('.ol-zoom-in').setAttribute('title','Povećaj');;
					document.querySelector('.ol-zoom-out').setAttribute('title','Smanji');;
					try{
						document.querySelector('.ol-full-screen').setAttribute('title','Cijeli ekran');
					}catch{}
					try{
						document.querySelector('.ol-full-screen-true').setAttribute('title','Izađi iz cijelog ekrana');
					}catch{}
					try{
						document.querySelector('.ol-full-screen-false').setAttribute('title','Cijeli ekran');
					}catch{}			
					document.getElementById('helpButtonLink').href='Marjan_Geoportal_korisnicki_prirucnik.pdf';					
				}
			});
			

			function loadTranslations(lang) {
				fetch("https://tblazevic1101.github.io/MarjanGeoportal/translations.json?14")
					.then(response => response.json())
					.then(data => {
						if (data[lang]) {
							const langData = data[lang];

							for (const key in langData) {
								if (langData.hasOwnProperty(key)) {
									const element = document.getElementById(key); // Assuming JSON keys are element IDs

									if (element) {
										const attributes = langData[key];

										for (const attr in attributes) {
											if (attributes.hasOwnProperty(attr)) {
												if (attr === "innerHTML") {													
													element.innerHTML  = attributes[attr];
												} else if (attr === "title") {
													element.title = attributes[attr];
												} else if (attr === "alt") {
													element.alt = attributes[attr];
												} else {
													// Handle other attributes as needed
													element.setAttribute(attr, attributes[attr]);
												}
											}
										}
									}
									else
									{
										console.log(key);
									}
								}
							}
						}
					})
					.catch(() => {});
			}
			
			document.querySelector('.ol-zoom-in').setAttribute('title','Povećaj');
			document.querySelector('.ol-zoom-out').setAttribute('title','Smanji');
			try{
				document.querySelector('.ol-full-screen').setAttribute('title','Cijeli ekran');
			}catch{}
			try{
			document.querySelector('.ol-full-screen-true').setAttribute('title','Izađi iz cijelog ekrana');
			}catch{}
			try{
				document.querySelector('.ol-full-screen-false').setAttribute('title','Cijeli ekran');
			}catch{}
			
			
			
			//const iframeDiv=document.getElementById('reportProblemPanel');
			//const iframe=document.getElementById('reportProblemIframe');
			//const reportProblemButton = document.getElementById('reportProblemButton'); // Replace with your button's ID
			
			
			/*function closeIframe() {
				iframeDiv.style.display = 'none';
			}
			
			iframe.onload = function() { // Attach onload event handler
				const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
				if (iframeDoc) { // Check if iframeDoc is available
					const input = iframeDoc.getElementById('textarea_comp-l6ouy886'); // ID of input in iframe
					input.focus();
					if (input) {
						input.innerHTML = 'UPISITE NEKU VRIJEDNOST';
					} else {
						console.error("Input not found");
					}
				} else {
					console.error("Iframe document not accessible");
				}
			};*/
			
			
			
			const reportProblemButton = document.getElementById('reportProblemButton'); // Replace with your button's ID
			
			
			reportProblemButton.addEventListener('click', () => {	
				//Opcija otvaranja web page-a sa sa stranicom park sume u novom tabu
				window.open('https://www.marjan-parksuma.hr/prijava', '_blank');
			
			
				//Opcija otvaranja web page-a sa sa stranicom park sume u iframeu
				/*if (iframeDiv.style.display === 'block'){
					iframeDiv.style.display = 'none'; 			
				}
				else{
					iframeDiv.style.display = 'block'; 
					iframe.src="https://www.marjan-parksuma.hr/prijava";
				}*/
				
				
				
				//Opcija otvaranja forme za unos prijave
				/*const reportProblemPanel=document.getElementById('reportIssuePanel')
				if (reportProblemPanel.style.display === 'block'){
					reportProblemPanel.style.display = 'none'; 			
				}
				else{
					reportProblemPanel.style.display = 'block'; 
					try{					
						if (document.getElementById('reportIssuePanelMyLocationRadio').checked){

							const geometry = positionFeature.getGeometry();

							if (geometry && geometry instanceof ol.geom.Point) {
								// Get the coordinates of the point
								const coordinates = geometry.getCoordinates();
								const transformedCoordinates = ol.proj.transform(coordinates, projection, 'EPSG:4326');

								document.getElementById('reportIssuePanelLocationInput').value = transformedCoordinates[0] + ', ' + transformedCoordinates[1]+'  ( '+"https://maps.google.com/maps?q="+transformedCoordinates[0].toFixed(6)+","+transformedCoordinates[1].toFixed(6)+' )';
							}
							else{
								document.getElementById('reportIssuePanelLocationInput').value ="";
								document.getElementById('reportIssuePanelNoLocationRadio').checked=true;
							}
						}
						else{
							if (document.getElementById('reportIssuePanelNoLocationRadio').checked==true){							
								document.getElementById('reportIssuePanelLocationInput').value ="";
								//document.getElementById('reportIssuePanelNoLocationRadio').checked=true;
							}
						}
					}catch{ 
						document.getElementById('reportIssuePanelLocationInput').value ="";	
						document.getElementById('reportIssuePanelNoLocationRadio').checked=true;										
					}
					//iframe.src="https://www.marjan-parksuma.hr/prijava";
				}*/
			});
			
			
			
			
			function handleReportProblemLocationRadioChange() {
				const selectedValue = document.querySelector('input[name="reportIssuePanelLocationChoice"]:checked').value;
				console.log("Selected location: " + selectedValue);
				
				// You can add more logic here to handle the selected value.
				if (selectedValue === 'currentLocation') {
					// Handle the current location case
					
					try{
						const geometry = positionFeature.getGeometry();

						if (geometry && geometry instanceof ol.geom.Point) {
							// Get the coordinates of the point
							const coordinates = geometry.getCoordinates();
							document.getElementById('reportIssuePanelLocationInput').value = coordinates[0] + ', ' + coordinates[1]+'  ( '+"https://maps.google.com/maps?q="+coordinates[0].toFixed(6)+","+coordinates[1].toFixed(6)+' )';
						}
						else{document.getElementById('reportIssuePanelLocationInput').value ="";}
					}catch{ console.log("Problem s trenutnom lokacijom");}
					console.log("Current location selected");
				} else if (selectedValue === 'mapSelection') {
					// Handle the map selection case
					console.log("Map selection chosen");
					document.getElementById('reportIssuePanel').style.display = 'none';
					
					map.once('click', function (event) {
						// Get the clicked location in pixel coordinates
						const pixel = event.pixel;

						// Convert the pixel coordinates to geographic coordinates (lon, lat)
						const coordinate = map.getCoordinateFromPixel(pixel);
						const lonLat = ol.proj.transform(coordinate, projection, 'EPSG:4326');
						//const lonLat = ol.proj.toLonLat(coordinate); // Converts from map projection to EPSG:4326 (lat, lon)

						// Log the geographic coordinates to the console
						console.log('Na lokaciji: ' + lonLat[0] + ', ' + lonLat[1]+'\n'+"https://maps.google.com/maps?q="+lonLat[0].toFixed(6)+","+lonLat[1].toFixed(6));

						// Optionally, display the coordinates inside the '1234' element
						document.getElementById('reportIssuePanelLocationInput').value = lonLat[0] + ', ' + lonLat[1]+'  ( '+"https://maps.google.com/maps?q="+lonLat[0].toFixed(6)+","+lonLat[1].toFixed(6)+' )';

						// Show the report issue panel again after the map selection
						document.getElementById('reportIssuePanel').style.display = 'block';
					});
					
				} else if (selectedValue === 'noLocation') {
					document.getElementById('reportIssuePanelLocationInput').value ='';
					console.log("No location selected");
				}
			}
			
			
			
			
		/*const wfsSource = new ol.source.Vector({
			format: new ol.format.GeoJSON(),
			url: function (extent) {
				return 'https://api.uredjenazemlja.hr/services/inspire/cp/wfs' +
					'?service=WFS' +
					'&version=2.0.0' +
					'&request=GetFeature' +
					'&typename=cp:CadastralParcel' +  // Layer name from GetCapabilities
					'&outputFormat=application/json' +
					'&srsname=EPSG:3765' +  // Coordinate reference system from GetCapabilities
					'&bbox=' + initialExtent.join(',') + ',EPSG:3765'; // Match projection
			},
			strategy: ol.loadingstrategy.bbox, // Loads features dynamically when viewport changes
		});*/

		// Define the WFS layer
		/*const wfsLayer = new ol.layer.Vector({
			source: wfsSource,
			style: new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: 'red',
					width: 2
				}),
				fill: new ol.style.Fill({
					color: 'rgba(255, 0, 0, 0.1)'
				})
			})
		});

		// Add the WFS layer to the map
		map.addLayer(wfsLayer);*/
			
		</script>
	</body>
</html>
